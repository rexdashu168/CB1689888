<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯è½‰å‚µç«¶æ‹æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 2rem; 
            margin-bottom: 10px; 
            font-weight: 600; 
        }
        .header p { 
            font-size: 0.95rem; 
            opacity: 0.9; 
        }
        .header-info { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            margin-top: 15px; 
            flex-wrap: wrap; 
        }
        .header-info-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem; 
            background: rgba(255, 255, 255, 0.2); 
            padding: 8px 16px; 
            border-radius: 20px; 
            transition: all 0.3s ease; 
            cursor: pointer; 
        }
        .header-info-item:hover { 
            background: rgba(255, 255, 255, 0.35); 
            transform: translateY(-2px); 
        }

        .data-update-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
            padding: 12px 30px;
            text-align: center;
            color: #e65100;
            font-size: 0.9rem;
            border-bottom: 2px solid #ffcc80;
        }

        .tabs { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 3px solid #dee2e6; 
        }
        .tab { 
            flex: 1; 
            padding: 12px 10px; 
            text-align: center; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            border-bottom: 3px solid transparent; 
            margin-bottom: -3px; 
            line-height: 1.3;
        }
        .tab:hover { 
            background: #e9ecef; 
        }
        .tab.active { 
            background: white; 
            border-bottom: 3px solid #667eea; 
            color: #667eea; 
        }
        
        .tab-content { 
            display: none; 
            padding: 30px; 
        }
        .tab-content.active { 
            display: block; 
        }
        
        .search-box { 
            max-width: 600px; 
            margin: 50px auto; 
            text-align: center; 
        }
        .search-box input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            border: 3px solid #667eea; 
            border-radius: 10px; 
        }
        .search-box input:focus { 
            outline: none; 
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); 
        }
        .search-hint { 
            color: #6c757d; 
            margin-top: 15px; 
            font-size: 0.9rem; 
        }
        
        .btn { 
            padding: 12px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 600; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); 
        }
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        .btn-secondary:hover { 
            background: #5a6268; 
            transform: translateY(-2px); 
        }
        
        .stats-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            background: white; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-size: 0.85rem;
        }
        .stats-table th { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 8px; 
            text-align: center; 
            font-size: 0.8rem; 
            border: 1px solid rgba(255,255,255,0.2); 
            white-space: nowrap;
        }
        .stats-table td { 
            padding: 10px 8px; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            font-size: 0.8rem; 
        }
        .stats-table tr:nth-child(even) { 
            background: #f8f9fa; 
        }
        .stats-table tr:hover { 
            background: #e7f3ff; 
        }
        .stats-table .highlight { 
            background: #fff3cd !important; 
            font-weight: 600; 
        }
        
        .info-card { 
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 4px solid #667eea; 
            margin-bottom: 20px; 
        }
        .info-card h4 { 
            color: #667eea; 
            margin-bottom: 15px; 
            font-size: 1.1rem; 
        }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
        }
        .info-item { 
            padding: 10px; 
            background: white; 
            border-radius: 6px; 
            text-align: center; 
        }
        .info-item .label { 
            font-size: 0.8rem; 
            color: #6c757d; 
            margin-bottom: 5px; 
        }
        .info-item .value { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: #495057; 
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .investor-type-selector {
            background: linear-gradient(135deg, #e8eaf6 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #5c6bc0;
        }
        
        .radio-group {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .type-descriptions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .type-desc-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #5c6bc0;
        }
        
        .type-desc-card h5 {
            color: #5c6bc0;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .type-desc-card p {
            font-size: 0.85rem;
            color: #616161;
            line-height: 1.6;
        }
        
        .warning-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-banner h4 {
            color: #d32f2f;
            margin-bottom: 10px;
        }
        
        .warning-banner p {
            color: #424242;
            line-height: 1.8;
            margin: 5px 0;
        }

        .calculator-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .calculator-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .price-chart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .price-line {
            padding: 8px 0;
        }

        .your-price-line {
            background: #fff3cd;
            font-weight: 600;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 5px 0;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .collapsible {
            background: #e3f2fd;
            cursor: pointer;
            padding: 15px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #1565c0;
        }

        .collapsible:hover {
            background: #bbdefb;
        }

        .collapsible-content {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .collapsible-content.active {
            display: block;
        }

        .upload-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #4caf50;
            text-align: center;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        #excelFileInput {
            display: none;
        }
        
        .footer { 
            padding: 20px 30px; 
            background: #f8f9fa; 
            border-top: 2px solid #e9ecef; 
            text-align: center; 
            color: #6c757d; 
            font-size: 0.85rem; 
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .tab { font-size: 0.9rem; padding: 15px 10px; }
            .radio-group { flex-direction: column; gap: 15px; }
            .calculator-input-group { grid-template-columns: 1fr; }
            .export-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å¯è½‰å‚µç«¶æ‹æŸ¥è©¢ç³»çµ±</h1>
            <p style="margin-bottom: 15px;">ç«¶æ‹çµ±è¨ˆæ•¸æ“š | æ™ºèƒ½æ¨¡æ“¬åˆ†æ | æŠ•æ¨™åƒ¹æ ¼è©¦ç®—</p>
            <div class="header-info">
                <div class="header-info-item"><span>ğŸ“…</span><span id="currentDate">è¼‰å…¥ä¸­...</span></div>
                <div class="header-info-item" onclick="window.open('https://vocus.cc/salon/655c9dbcfd897800019d5bb4', '_blank')"><span>ğŸ“</span><span>æ–¹æ ¼å­éƒ¨è½æ ¼</span></div>
                <div class="header-info-item" onclick="window.open('https://www.youtube.com/@rexdashu168', '_blank')"><span>ğŸ¬</span><span>YouTubeé »é“</span></div>
            </div>
            <p style="margin-top: 12px; font-size: 0.85rem; opacity: 0.85;">by Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</p>
        </div>

        <div class="data-update-banner" id="dataUpdateBanner">
            ğŸ“… è¼‰å…¥ä¸­...
        </div>

        <!-- Excelä¸Šå‚³å€ -->
        <div class="upload-section">
            <h3 style="color: #2e7d32; margin-bottom: 15px;">ğŸ“‚ åŒ¯å…¥ç«¶æ‹è³‡æ–™</h3>
            <p style="color: #616161; margin-bottom: 20px; font-size: 0.9rem;">è«‹ä¸Šå‚³åŒ…å«30å€‹æ¬„ä½çš„ Excel æª”æ¡ˆï¼ˆauction_data.xlsxï¼‰</p>
            <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
            <button class="upload-btn" onclick="document.getElementById('excelFileInput').click()">
                ğŸ“¤ é¸æ“‡ Excel æª”æ¡ˆ
            </button>
            <p id="uploadStatus" style="margin-top: 15px; font-weight: 600; color: #2e7d32;"></p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('single')">ğŸ”<br>å–®æª”æŸ¥è©¢</div>
            <div class="tab" onclick="switchTab('batch')">ğŸ“Š<br>æ‰¹æ¬¡æŸ¥è©¢</div>
            <div class="tab" onclick="switchTab('filter')">âš™ï¸<br>æ¢ä»¶ç¯©é¸</div>
            <div class="tab" onclick="switchTab('calculator')">ğŸ¯<br>æŠ•æ¨™è¨ˆç®—æ©Ÿ</div>
        </div>

        <!-- Tab 1: å–®æª”æŸ¥è©¢ -->
        <div id="tab-single" class="tab-content active">
            <div class="search-box">
                <h2 style="margin-bottom: 20px; color: #495057;">ğŸ” å–®æª”æ­·å²æŸ¥è©¢</h2>
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #2196f3;">
                    <h4 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ’¡</span><span>åŠŸèƒ½èªªæ˜</span>
                    </h4>
                    <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                        <p style="margin-bottom: 8px;"><strong>æŸ¥è©¢æ–¹å¼ï¼š</strong>è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€CBä»£è™Ÿæˆ–å…¬å¸åç¨±</p>
                        <p style="margin-bottom: 8px;"><strong>é¡¯ç¤ºå…§å®¹ï¼š</strong>è©²å…¬å¸æ‰€æœ‰æ­·æ¬¡ç™¼è¡Œçš„å¯è½‰å‚µç«¶æ‹è¨˜éŒ„</p>
                        <p style="margin-bottom: 0;"><strong>ä½¿ç”¨ç¯„ä¾‹ï¼š</strong>è¼¸å…¥ã€Œ3617ã€æˆ–ã€Œç¢©å¤©ã€â†’ é¡¯ç¤ºç¢©å¤©ä¸€ã€ç¢©å¤©äºŒã€ç¢©å¤©ä¸‰...å®Œæ•´æ­·å²è³‡æ–™</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center; max-width: 600px; margin: 0 auto;">
                    <input type="text" id="singleSearchInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±å¾ŒæŒ‰EnteræŸ¥è©¢" 
                        onkeyup="if(event.key==='Enter') executeSingleSearch()">
                    <button class="btn btn-primary" onclick="executeSingleSearch()">æŸ¥è©¢</button>
                </div>
                <p class="search-hint">æŸ¥è©¢è©²å…¬å¸æ‰€æœ‰å¯è½‰å‚µç«¶æ‹æ­·å²è¨˜éŒ„</p>
            </div>
            <div id="singleResult"></div>
        </div>

        <!-- Tab 2: æ‰¹æ¬¡æŸ¥è©¢ -->
        <div id="tab-batch" class="tab-content">
            <div class="search-box">
                <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“Š æ‰¹æ¬¡æ¯”è¼ƒæŸ¥è©¢ï¼ˆæœ€å¤š20æª”ï¼‰</h2>
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ’¡</span><span>åŠŸèƒ½èªªæ˜</span>
                    </h4>
                    <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                        <p style="margin-bottom: 8px;"><strong>æŸ¥è©¢æ–¹å¼ï¼š</strong>è‡ªç”±åŠ å…¥å¤šæª”ä¸åŒæ¨™çš„é€²è¡Œæ¯”è¼ƒåˆ†æï¼ˆæœ€å¤š20æª”ï¼‰</p>
                        <p style="margin-bottom: 8px;"><strong>é¡¯ç¤ºå…§å®¹ï¼š</strong>ç¶œåˆçµ±è¨ˆè¡¨ã€æ™ºèƒ½æŠ•æ¨™å»ºè­°ï¼ˆä¿å®ˆ/ç©©å¥/ç©æ¥µï¼‰</p>
                        <p style="margin-bottom: 0;"><strong>é©åˆç”¨æ–¼ï¼š</strong>æ¯”è¼ƒä¸åŒå…¬å¸ã€è©•ä¼°æŠ•è³‡çµ„åˆã€åˆ¶å®šæŠ•æ¨™ç­–ç•¥</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center; max-width: 600px; margin: 0 auto;">
                    <input type="text" id="batchSearchInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±å¾ŒæŒ‰EnteråŠ å…¥" 
                        onkeyup="if(event.key==='Enter') addToBatchList()">
                    <button class="btn btn-primary" onclick="addToBatchList()">åŠ å…¥</button>
                </div>
                <p class="search-hint">é€ç­†åŠ å…¥ä¸åŒæ¨™çš„ï¼Œå»ºç«‹è‡ªå·±çš„æ¯”è¼ƒæ¸…å–®</p>
                
                <div id="batchList" style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;"></div>
                
                <div id="batchButtons" style="display: none; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="executeBatchSearch()">ğŸ” é–‹å§‹åˆ†æ</button>
                    <button class="btn btn-secondary" onclick="clearBatchList()">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
                </div>
            </div>
            <div id="batchResult"></div>
            
            <div id="batchChecklist" style="display: none;">
                <div style="background: linear-gradient(135deg, #e8eaf6 0%, #ffffff 100%); padding: 25px; margin: 20px 30px; border-radius: 10px; border-left: 4px solid #5c6bc0;">
                    <h3 style="color: #3f51b5; margin-bottom: 15px;">ğŸ“‹ æŠ•æ¨™å‰åƒè€ƒæª¢æŸ¥æ¸…å–®</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">â° æ™‚æ©Ÿé¸æ“‡</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                âœ“ æˆªæ¨™æ—¥1:30æ”¶ç›¤å¾Œå†æŠ•æ¨™<br>
                                âœ“ é¿å…åƒ¹æ ¼æ³¢å‹•æœŸé–“æ±ºç­–<br>
                                âœ“ è¨ˆç®—ã€Œéœæ­¢çš„ç†è«–åƒ¹æ ¼ã€
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">ğŸ’° é¢¨éšªè©•ä¼°</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                âœ“ è¨ˆç®—æœ€å¤§æå¤±ï¼šæŠ•æ¨™åƒ¹-100å…ƒ<br>
                                âœ“ è©•ä¼°å¯æ‰¿å—çš„é¢¨éšªé‡‘é¡<br>
                                âœ“ è€ƒæ…®ä¿¡è©•ã€æ“”ä¿ã€å¹´æœŸ
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">ğŸ“Š æ•¸æ“šåƒè€ƒ</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                âœ“ åƒè€ƒæ­·å²å¹³å‡å¾—æ¨™åƒ¹<br>
                                âœ“ è§€å¯ŸæŠ•æ¨™å€æ•¸ï¼ˆæŠ•è³‡æ°›åœï¼‰<br>
                                âœ“ æ¯”è¼ƒåŒé¡æ¨™çš„è¡¨ç¾
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">âš ï¸ é‡è¦æé†’</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                âœ“ æŠ•æ¨™å¾Œç„¡æ³•å–æ¶ˆï¼ˆåƒ…èƒ½æ£„æ¨™ï¼‰<br>
                                âœ“ æŠ•å®Œæ¨™å‹™å¿…å†æ¬¡æª¢æŸ¥<br>
                                âœ“ ç¢ºä¿äº¤å‰²è³‡é‡‘å……è¶³
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; font-size: 0.9rem; color: #856404;">
                        <strong>ğŸ’¡ Rexå¤§å”æé†’ï¼š</strong>å°ˆæ³¨æ–¼é¢¨éšªæ§åˆ¶ï¼Œä¸è¿½æ±‚æš´åˆ©ã€‚ç›®æ¨™æ˜¯ä»¥æœ€æ¥è¿‘æœ€ä½å¾—æ¨™åƒ¹æ‹åˆ°ï¼Œæ§åˆ¶æˆæœ¬æ‰æ˜¯é•·æœŸç²åˆ©çš„é—œéµã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: æ¢ä»¶ç¯©é¸ -->
        <div id="tab-filter" class="tab-content">
            <h2 style="color: #495057; margin-bottom: 20px;">âš™ï¸ æ¢ä»¶ç¬¦åˆåº¦åˆ†æ</h2>
            
            <div class="investor-type-selector">
                <h3 style="color: #3f51b5; margin-bottom: 15px; text-align: center;">è«‹é¸æ“‡åƒè€ƒæ¨™æº–</h3>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="investorType" value="conservative" checked onchange="updateInvestorType()">
                        <span>æ¨™æº–Aï¼šé‡è¦–é¢¨éšªæ§åˆ¶</span>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="investorType" value="balanced" onchange="updateInvestorType()">
                        <span>æ¨™æº–Bï¼šå¹³è¡¡é…ç½®</span>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="investorType" value="aggressive" onchange="updateInvestorType()">
                        <span>æ¨™æº–Cï¼šé‡è¦–è¡¨ç¾</span>
                    </label>
                </div>
                <div class="type-descriptions">
                    <div class="type-desc-card">
                        <h5>æ¨™æº–Aï¼šé‡è¦–é¢¨éšªæ§åˆ¶</h5>
                        <p>ç†è«–åƒ¹å€¼40%ã€é¢¨éšªå› ç´ 30%ã€æ›ç‰Œè¡¨ç¾20%ã€æ¢ä»¶æ•¸é‡10%</p>
                    </div>
                    <div class="type-desc-card">
                        <h5>æ¨™æº–Bï¼šå¹³è¡¡é…ç½®</h5>
                        <p>ç†è«–åƒ¹å€¼30%ã€æ›ç‰Œè¡¨ç¾30%ã€æ¢ä»¶æ•¸é‡25%ã€é¢¨éšªå› ç´ 15%</p>
                    </div>
                    <div class="type-desc-card">
                        <h5>æ¨™æº–Cï¼šé‡è¦–è¡¨ç¾</h5>
                        <p>æ›ç‰Œè¡¨ç¾45%ã€æ¢ä»¶æ•¸é‡25%ã€ç†è«–åƒ¹å€¼20%ã€é¢¨éšªå› ç´ 10%</p>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #616161;">
                    èªªæ˜ï¼šä¸åŒæ¨™æº–åæ˜ ä¸åŒåƒè€ƒé‡é»ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
                </p>
            </div>
            
            <div class="filter-section">
                <h3 style="color: #495057; margin-bottom: 20px;">ç¯©é¸æ¢ä»¶è¨­å®šï¼ˆè«‹è‡³å°‘é¸æ“‡5å€‹æ¢ä»¶ï¼‰</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="filter-group">
                        <label>ğŸ­ ç”¢æ¥­åˆ†é¡</label>
                        <select id="filterIndustry">
                            <option value="">å…¨éƒ¨</option>
                            <option value="åŒ–å­¸å·¥æ¥­">åŒ–å­¸å·¥æ¥­</option>
                            <option value="èˆªé‹æ¥­">èˆªé‹æ¥­</option>
                            <option value="è³‡è¨Šæœå‹™æ¥­">è³‡è¨Šæœå‹™æ¥­</option>
                            <option value="å…¶ä»–é›»å­æ¥­">å…¶ä»–é›»å­æ¥­</option>
                            <option value="æ²¹é›»ç‡ƒæ°£æ¥­">æ²¹é›»ç‡ƒæ°£æ¥­</option>
                            <option value="è¾²æ¥­ç§‘æŠ€æ¥­">è¾²æ¥­ç§‘æŠ€æ¥­</option>
                            <option value="æ–‡åŒ–å‰µæ„æ¥­">æ–‡åŒ–å‰µæ„æ¥­</option>
                            <option value="ç”ŸæŠ€é†«ç™‚æ¥­">ç”ŸæŠ€é†«ç™‚æ¥­</option>
                            <option value="å»ºæç‡Ÿé€ æ¥­">å»ºæç‡Ÿé€ æ¥­</option>
                            <option value="é›»å­é›¶çµ„ä»¶æ¥­">é›»å­é›¶çµ„ä»¶æ¥­</option>
                            <option value="é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­">é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­</option>
                            <option value="é›»æ©Ÿæ©Ÿæ¢°">é›»æ©Ÿæ©Ÿæ¢°</option>
                            <option value="åŠå°é«”æ¥­">åŠå°é«”æ¥­</option>
                            <option value="è­‰åˆ¸æ¥­">è­‰åˆ¸æ¥­</option>
                            <option value="é‹å‹•ä¼‘é–’">é‹å‹•ä¼‘é–’</option>
                            <option value="å…‰é›»æ¥­">å…‰é›»æ¥­</option>
                            <option value="ç¶ èƒ½ç’°ä¿">ç¶ èƒ½ç’°ä¿</option>
                            <option value="é›»å™¨é›»çºœ">é›»å™¨é›»çºœ</option>
                            <option value="å…¶ä»–æ¥­">å…¶ä»–æ¥­</option>
                            <option value="é€šä¿¡ç¶²è·¯æ¥­">é€šä¿¡ç¶²è·¯æ¥­</option>
                            <option value="é›»å­é€šè·¯æ¥­">é›»å­é€šè·¯æ¥­</option>
                            <option value="è§€å…‰é¤æ—…">è§€å…‰é¤æ—…</option>
                            <option value="è²¿æ˜“ç™¾è²¨æ¥­">è²¿æ˜“ç™¾è²¨æ¥­</option>
                            <option value="é‹¼éµå·¥æ¥­">é‹¼éµå·¥æ¥­</option>
                            <option value="æ±½è»Šå·¥æ¥­">æ±½è»Šå·¥æ¥­</option>
                            <option value="å±…å®¶ç”Ÿæ´»">å±…å®¶ç”Ÿæ´»</option>
                            <option value="é€ ç´™å·¥æ¥­">é€ ç´™å·¥æ¥­</option>
                            <option value="å¡‘è† å·¥æ¥­">å¡‘è† å·¥æ¥­</option>
                            <option value="ç´¡ç¹”çº–ç¶­">ç´¡ç¹”çº–ç¶­</option>
                            <option value="é£Ÿå“å·¥æ¥­">é£Ÿå“å·¥æ¥­</option>
                            <option value="æ•¸ä½é›²ç«¯">æ•¸ä½é›²ç«¯</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>ğŸ¢ ç™¼è¡Œåˆ¸å•†</label>
                        <select id="filterUnderwriter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="çµ±ä¸€è­‰åˆ¸">çµ±ä¸€è­‰åˆ¸</option>
                            <option value="ç¬¬ä¸€é‡‘è­‰">ç¬¬ä¸€é‡‘è­‰</option>
                            <option value="åœ‹ç¥¨è­‰åˆ¸">åœ‹ç¥¨è­‰åˆ¸</option>
                            <option value="å¯Œé‚¦è­‰åˆ¸">å¯Œé‚¦è­‰åˆ¸</option>
                            <option value="æ°¸è±é‡‘è­‰">æ°¸è±é‡‘è­‰</option>
                            <option value="å‡±åŸºè­‰åˆ¸">å‡±åŸºè­‰åˆ¸</option>
                            <option value="å°æ–°è­‰åˆ¸">å°æ–°è­‰åˆ¸</option>
                            <option value="ä¸­ä¿¡è­‰åˆ¸">ä¸­ä¿¡è­‰åˆ¸</option>
                            <option value="ç¾¤ç›Šè­‰åˆ¸">ç¾¤ç›Šè­‰åˆ¸</option>
                            <option value="å°ä¸­éŠ€è­‰">å°ä¸­éŠ€è­‰</option>
                            <option value="å…ƒå¤§è­‰åˆ¸">å…ƒå¤§è­‰åˆ¸</option>
                            <option value="åœ‹æ³°è­‰åˆ¸">åœ‹æ³°è­‰åˆ¸</option>
                            <option value="è¯å—æ°¸æ˜Œ">è¯å—æ°¸æ˜Œ</option>
                            <option value="åˆåº«è­‰åˆ¸">åˆåº«è­‰åˆ¸</option>
                            <option value="ç¦é‚¦è­‰åˆ¸">ç¦é‚¦è­‰åˆ¸</option>
                            <option value="å…†è±è­‰åˆ¸">å…†è±è­‰åˆ¸</option>
                            <option value="å®é è­‰åˆ¸">å®é è­‰åˆ¸</option>
                            <option value="æ°¸è±è­‰åˆ¸">æ°¸è±è­‰åˆ¸</option>
                            <option value="åº·å’Œè­‰åˆ¸">åº·å’Œè­‰åˆ¸</option>
                            <option value="å…ƒå¯Œè­‰åˆ¸">å…ƒå¯Œè­‰åˆ¸</option>
                            <option value="ç‰å±±è­‰åˆ¸">ç‰å±±è­‰åˆ¸</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ğŸ“Š è‚¡æœ¬å€é–“</label>
                        <select id="filterCapital">
                            <option value="">å…¨éƒ¨</option>
                            <option value="<3">å°æ–¼3å„„</option>
                            <option value="3-6">3~6å„„</option>
                            <option value="6-10">6~10å„„</option>
                            <option value="10-15">10~15å„„</option>
                            <option value="15-20">15~20å„„</option>
                            <option value=">20">20å„„ä»¥ä¸Š</option>
                            <option value="<10">å°æ–¼10å„„</option>
                            <option value=">10">å¤§æ–¼10å„„</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ğŸ’° ç™¼è¡Œè¦æ¨¡</label>
                        <select id="filterScale">
                            <option value="">å…¨éƒ¨</option>
                            <option value="<2">å°æ–¼2å„„</option>
                            <option value="2-3">2~3å„„</option>
                            <option value="3-6">3~6å„„</option>
                            <option value="6-10">6~10å„„</option>
                            <option value="10-15">10~15å„„</option>
                            <option value="15-20">15~20å„„</option>
                            <option value=">20">20å„„ä»¥ä¸Š</option>
                            <option value="<5">5å„„ä»¥ä¸‹</option>
                            <option value=">5">5å„„ä»¥ä¸Š</option>
                            <option value="<10">10å„„ä»¥ä¸‹</option>
                            <option value=">10">10å„„ä»¥ä¸Š</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ğŸ’µ è½‰æ›åƒ¹æ ¼</label>
                        <select id="filterConvPrice">
                            <option value="">å…¨éƒ¨</option>
                            <option value="<20">20å…ƒä»¥ä¸‹</option>
                            <option value="20-50">20~50å…ƒ</option>
                            <option value="50-100">50~100å…ƒ</option>
                            <option value="100-150">100~150å…ƒ</option>
                            <option value="150-200">150~200å…ƒ</option>
                            <option value=">200">200å…ƒä»¥ä¸Š</option>
                            <option value="<50">50å…ƒä»¥ä¸‹</option>
                            <option value=">50">50å…ƒä»¥ä¸Š</option>
                            <option value="<100">100å…ƒä»¥ä¸‹</option>
                            <option value=">100">100å…ƒä»¥ä¸Š</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>â­ TCRIä¿¡ç”¨è©•ç­‰</label>
                        <select id="filterRating">
                            <option value="">å…¨éƒ¨</option>
                            <option value="2">2åˆ†</option>
                            <option value="3">3åˆ†</option>
                            <option value="4">4åˆ†</option>
                            <option value="5">5åˆ†</option>
                            <option value="6">6åˆ†</option>
                            <option value="7">7åˆ†</option>
                            <option value="8">8åˆ†</option>
                            <option value="9">9åˆ†</option>
                            <option value="<=4">4åˆ†ä»¥ä¸‹ï¼ˆå«ï¼‰</option>
                            <option value=">=5">5åˆ†ä»¥ä¸Šï¼ˆå«ï¼‰</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ğŸ“… ç™¼è¡Œå¹´æœŸ</label>
                        <select id="filterPeriod">
                            <option value="">å…¨éƒ¨</option>
                            <option value="3">3å¹´</option>
                            <option value="5">5å¹´</option>
                            <option value="7">7å¹´</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ğŸ›¡ï¸ æ“”ä¿æƒ…æ³</label>
                        <select id="filterSecured">
                            <option value="">å…¨éƒ¨</option>
                            <option value="æœ‰">æœ‰æ“”ä¿</option>
                            <option value="ç„¡">ç„¡æ“”ä¿</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="executeFilterSearch()">ğŸ” é–‹å§‹åˆ†æ</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®æ¢ä»¶</button>
                </div>
            </div>
            
            <div id="filterResult"></div>
        </div>

        <!-- Tab 4: æŠ•æ¨™è¨ˆç®—æ©Ÿ -->
        <div id="tab-calculator" class="tab-content">
            <h2 style="color: #495057; margin-bottom: 20px; text-align: center;">ğŸ¯ æŠ•æ¨™è¨ˆç®—æ©Ÿ</h2>
            
            <button class="collapsible" onclick="toggleCollapsible(this)">ğŸ“– ä½¿ç”¨èªªæ˜ï¼ˆé»æ“Šå±•é–‹ï¼‰</button>
            <div class="collapsible-content">
                <h4 style="color: #1976d2; margin-bottom: 12px;">ğŸ’¡ åŠŸèƒ½èªªæ˜</h4>
                <div style="line-height: 1.8; color: #424242;">
                    <p><strong>1ï¸âƒ£</strong> è«‹å…ˆåˆ°ã€Œæ¢ä»¶ç¯©é¸ã€é¸æ“‡è‡³å°‘5å€‹æ¢ä»¶</p>
                    <p><strong>2ï¸âƒ£</strong> è¼¸å…¥è½‰æ›åƒ¹æ ¼å’Œè‚¡ç¥¨å¸‚åƒ¹è¨ˆç®—ç†è«–åƒ¹å€¼</p>
                    <p><strong>3ï¸âƒ£</strong> è¼¸å…¥æ‚¨æƒ³æŠ•æ¨™çš„åƒ¹æ ¼</p>
                    <p><strong>4ï¸âƒ£</strong> ç³»çµ±æœƒåˆ†æèˆ‡æ­·å²æ•¸æ“šçš„å·®ç•°</p>
                    <p><strong>5ï¸âƒ£</strong> å¯é€²è¡Œæƒ…å¢ƒæ¯”è¼ƒèˆ‡åŒ¯å‡ºå ±å‘Š</p>
                    <p style="margin-top: 10px; color: #856404; background: #fff3cd; padding: 10px; border-radius: 6px;">
                        <strong>âš ï¸ é‡è¦ï¼š</strong>æ‰€æœ‰åˆ†æçµæœåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
                    </p>
                </div>
            </div>

            <div id="calculatorCheckConditions"></div>
            <div id="calculatorMain" style="display: none;">
                <div class="calculator-section">
                    <h3 style="color: #495057; margin-bottom: 20px;">ğŸ“Š ç†è«–åƒ¹å€¼è¨ˆç®—</h3>
                    <div class="calculator-input-group">
                        <div class="filter-group">
                            <label>è½‰æ›åƒ¹æ ¼ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="calcConvPrice" placeholder="ä¾‹å¦‚ï¼š44.00" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label>è‚¡ç¥¨å¸‚åƒ¹ï¼ˆå…ƒï¼‰- æˆªæ¨™æ—¥1:30æ”¶ç›¤åƒ¹</label>
                            <input type="number" id="calcStockPrice" placeholder="ä¾‹å¦‚ï¼š41.20" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label>ç†è«–åƒ¹å€¼ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                            <input type="text" id="calcTheoretical" readonly style="background: #e9ecef; font-weight: 600;">
                        </div>
                    </div>
                </div>

                <div class="calculator-section">
                    <h3 style="color: #495057; margin-bottom: 20px;">ğŸ¯ æŠ•æ¨™åƒ¹æ ¼è©¦ç®—</h3>
                    <div class="calculator-input-group">
                        <div class="filter-group">
                            <label>æ‚¨æƒ³æŠ•æ¨™çš„åƒ¹æ ¼ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="calcBidPrice" placeholder="ä¾‹å¦‚ï¼š112.00" step="0.01">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="analyzePrice()">ğŸ” é–‹å§‹åˆ†æ</button>
                    </div>
                </div>

                <div id="calculatorResult"></div>
            </div>
        </div>

        <div class="warning-banner">
            <h4>âš ï¸ é‡è¦æç¤º</h4>
            <p>æœ¬ç³»çµ±æä¾›æ­·å²æ•¸æ“šçµ±è¨ˆèˆ‡è³‡æ–™æ•´ç†ï¼Œæ‰€æœ‰æ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°</p>
            <p>éå»è¡¨ç¾ä¸ä»£è¡¨æœªä¾†çµæœï¼ŒæŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œè©•ä¼°é¢¨éšª</p>
        </div>

        <div class="footer">
            <p style="font-weight: 500;">è³‡æ–™ä¾†æºï¼šè­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒ</p>
            <p style="margin-top: 8px; color: #f44336; font-weight: 500;">âš ï¸ æœ¬è¡¨åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œè©•ä¼°é¢¨éšª</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">ğŸ“š Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</p>
                <p style="font-size: 0.85rem; color: #6c757d;">æ›´å¤šæŠ•è³‡è§€å¿µèˆ‡å¯è½‰å‚µåˆ†æï¼Œæ­¡è¿è¨‚é–±å­¸ç¿’</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let auctionData = [];
        let batchListItems = [];
        let currentInvestorType = 'conservative';
        let selectedFilterConditions = {};
        let currentAnalysisData = null;

        // ==================== Excel ä¸Šå‚³èˆ‡è§£æåŠŸèƒ½ ====================
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // è½‰æ›è³‡æ–™æ ¼å¼
                    auctionData = jsonData.map(row => {
                        // è¨ˆç®—æŠ•è³‡æ°›åœ
                        const atmosphere = calculateAtmosphere(row['æŠ•æ¨™å€æ•¸']);
                        
                        return {
                            no: row['åºè™Ÿ'],
                            date: formatDate(row['é–‹æ¨™æ—¥æœŸ']),
                            stockCode: String(row['è‚¡ç¥¨ä»£è™Ÿ']),
                            cbCode: String(row['CBä»£è™Ÿ']),
                            name: row['åç¨±'],
                            capital: parseFloat(row['è‚¡æœ¬']) || 0,
                            scale: parseFloat(row['ç™¼è¡Œè¦æ¨¡']) || 0,
                            period: row['å¹´æœŸ'] + 'å¹´',
                            secured: row['æ“”ä¿'],
                            rating: parseInt(row['ä¿¡è©•']) || 0,
                            volume: parseInt(row['ç«¶æ‹å¼µæ•¸']) || 0,
                            floor: parseFloat(row['åº•æ¨™åƒ¹']) || 0,
                            cutoffDate: formatDate(row['æˆªæ¨™æ—¥']),
                            cutoffPrice: parseFloat(row['æˆªæ¨™æ”¶ç›¤']) || 0,
                            convPrice: parseFloat(row['è½‰æ›åƒ¹']) || 0,
                            pricePremium: row['è¨‚åƒ¹æº¢åƒ¹ç‡'],
                            theoretical: parseFloat(row['ç†è«–åƒ¹']) || 0,
                            minBid: parseFloat(row['æœ€ä½å¾—æ¨™']) || 0,
                            minPremium: parseFloat(row['æœ€ä½æº¢åƒ¹']) || 0,
                            avgBid: parseFloat(row['å¹³å‡å¾—æ¨™']) || 0,
                            avgPremium: parseFloat(row['å¹³å‡æº¢åƒ¹']) || 0,
                            listHigh: parseFloat(row['æ›ç‰Œæœ€é«˜']) || 0,
                            listLow: parseFloat(row['æ›ç‰Œæœ€ä½']) || 0,
                            underwriter: row['ç™¼è¡Œåˆ¸å•†'],
                            industry: row['ç”¢æ¥­åˆ†é¡'],
                            qualifiedCount: parseInt(row['åˆæ ¼ä»¶æ•¸']) || 0,
                            bidVolume: parseInt(row['æŠ•æ¨™å¼µæ•¸']) || 0,
                            bidMultiple: parseFloat(row['æŠ•æ¨™å€æ•¸']) || 0,
                            avgBidVolume: parseFloat(row['æŠ•æ¨™å‡å¼µ']) || 0,
                            closePrice: parseFloat(row['CBæœ€æ–°æ”¶ç›¤åƒ¹']) || null,
                            atmosphere: atmosphere
                        };
                    });

                    document.getElementById('uploadStatus').innerHTML = 
                        `âœ… æˆåŠŸè¼‰å…¥ ${auctionData.length} ç­†è³‡æ–™ï¼`;
                    document.getElementById('uploadStatus').style.color = '#2e7d32';
                    
                    // æ›´æ–°è³‡æ–™æœŸé–“è³‡è¨Š
                    updateDataPeriodInfo();
                    
                    // æ¸…ç©ºä¹‹å‰çš„æŸ¥è©¢çµæœ
                    document.getElementById('singleResult').innerHTML = '';
                    document.getElementById('batchResult').innerHTML = '';
                    document.getElementById('filterResult').innerHTML = '';
                    
                    setTimeout(() => {
                        document.getElementById('uploadStatus').innerHTML = '';
                    }, 3000);

                } catch (error) {
                    document.getElementById('uploadStatus').innerHTML = 
                        `âŒ æª”æ¡ˆè§£æå¤±æ•—ï¼š${error.message}`;
                    document.getElementById('uploadStatus').style.color = '#d32f2f';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•¸
        function formatDate(excelDate) {
            if (typeof excelDate === 'string') return excelDate;
            
            // Excelæ—¥æœŸè½‰æ›
            const date = XLSX.SSF.parse_date_code(excelDate);
            return `${date.y}/${String(date.m).padStart(2, '0')}/${String(date.d).padStart(2, '0')}`;
        }

        // è¨ˆç®—æŠ•è³‡æ°›åœ
        function calculateAtmosphere(bidMultiple) {
            if (!bidMultiple || bidMultiple < 3) return 'ğŸ˜Š';
            if (bidMultiple <= 5) return 'ğŸ”¥';
            return 'ğŸš€';
        }

        // ==================== åŸºç¤åŠŸèƒ½ ====================
        function displayCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', options);
        }

        function updateDataPeriodInfo() {
            if (auctionData.length === 0) {
                document.getElementById('dataUpdateBanner').innerHTML = 'ğŸ“… è«‹å…ˆä¸Šå‚³ Excel è³‡æ–™æª”æ¡ˆ';
                return;
            }

            // å–å¾—æœ€æ—©å’Œæœ€æ™šçš„è³‡æ–™
            const sortedData = [...auctionData].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });

            const firstData = sortedData[0];
            const lastData = sortedData[sortedData.length - 1];
            
            // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
            };

            const startPeriod = formatDate(firstData.date);
            const endPeriod = formatDate(lastData.date);
            
            // æ›´æ–°æ©«å¹…å…§å®¹
            document.getElementById('dataUpdateBanner').innerHTML = `
                ğŸ“… ç«¶æ‹è³‡æ–™æœŸé–“ï¼š${startPeriod}ï½${endPeriod}ï¼Œå…±è¨ˆ <strong>${auctionData.length}</strong> æª” | 
                ğŸ’° CBæœ€æ–°æ”¶ç›¤åƒ¹ï¼š<strong>2025/10/27</strong>
            `;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'calculator') {
                checkCalculatorConditions();
            }
        }

        function updateInvestorType() {
            const selected = document.querySelector('input[name="investorType"]:checked');
            currentInvestorType = selected.value;
            localStorage.setItem('investorType', currentInvestorType);
        }

        function toggleCollapsible(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        }

        // ==================== å–®æª”æŸ¥è©¢åŠŸèƒ½ ====================
        function executeSingleSearch() {
            if (auctionData.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³ Excel è³‡æ–™æª”æ¡ˆ');
                return;
            }

            const input = document.getElementById('singleSearchInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                alert('è«‹è¼¸å…¥æŸ¥è©¢é—œéµå­—');
                return;
            }
            
            const results = auctionData.filter(item => 
                item.stockCode.includes(keyword) || 
                item.cbCode.includes(keyword) || 
                item.name.includes(keyword)
            );
            
            if (results.length === 0) {
                document.getElementById('singleResult').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #dc3545;">âŒ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥å…§å®¹</div>';
                return;
            }
            
            displaySingleResult(results, keyword);
        }

        function displaySingleResult(results, keyword) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;
            
            const companyName = results[0].name.replace(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]/g, '');
            
            let html = `
                <div style="margin: 30px; overflow-x: auto;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin-bottom: 15px;">ğŸ“Š ${companyName} æ­·å²ç«¶æ‹è¨˜éŒ„</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9rem; color: #424242;">
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">è‚¡ç¥¨ä»£è™Ÿ</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${results[0].stockCode}</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">æŸ¥è©¢é—œéµå­—</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${keyword}</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">æ­·å²è¨˜éŒ„</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${results.length} æª”å¯è½‰å‚µ</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">å¹³å‡æŠ•æ¨™å€æ•¸</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${avgBidMultiple.toFixed(2)}å€</strong>
                            </div>
                        </div>
                    </div>
                    
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>åºè™Ÿ</th>
                                <th>é–‹æ¨™æ—¥æœŸ</th>
                                <th>CBä»£è™Ÿ</th>
                                <th>åç¨±</th>
                                <th>ç”¢æ¥­</th>
                                <th>åˆ¸å•†</th>
                                <th>è¦æ¨¡</th>
                                <th>å¹´æœŸ</th>
                                <th>æ“”ä¿</th>
                                <th>ä¿¡è©•</th>
                                <th>æŠ•æ¨™<br>å€æ•¸</th>
                                <th>æœ€ä½<br>å¾—æ¨™</th>
                                <th>æœ€ä½<br>æº¢åƒ¹</th>
                                <th>å¹³å‡<br>å¾—æ¨™</th>
                                <th>å¹³å‡<br>æº¢åƒ¹</th>
                                <th>æ›ç‰Œ<br>æœ€é«˜</th>
                                <th>æ›ç‰Œ<br>æ¼²å¹…</th>
                                <th>æœ€æ–°<br>æ”¶ç›¤</th>
                                <th>æ°›åœ</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                let closePriceDisplay = '---';
                let priceDiffDisplay = '';
                if (item.closePrice) {
                    closePriceDisplay = item.closePrice.toFixed(2);
                    const diffMinBid = item.closePrice - item.minBid;
                    const diffPercent = (diffMinBid / item.minBid * 100).toFixed(1);
                    priceDiffDisplay = `<br><small style="color: ${diffMinBid >= 0 ? '#28a745' : '#dc3545'};">${diffMinBid >= 0 ? '+' : ''}${diffMinBid.toFixed(2)} (${diffPercent}%)</small>`;
                }
                
                html += `
                    <tr>
                        <td>${item.no}</td>
                        <td>${item.date}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}å„„</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === 'æœ‰' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === 'æœ‰' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#28a745' : '#dc3545'};">${gainRate.toFixed(1)}%</td>
                        <td>${closePriceDisplay}${priceDiffDisplay}</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });
            
            html += `
                        <tr class="highlight">
                            <td colspan="10" style="text-align: right; padding-right: 20px;">ğŸ“Š æ­·å²å¹³å‡å€¼</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#28a745' : '#dc3545'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #2196f3;">
                    <h4 style="color: #1976d2; margin-bottom: 20px; font-size: 1.1rem;">ğŸ“ˆ ${companyName} æ­·å²è¶¨å‹¢åˆ†æ</h4>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">ç™¼è¡Œæ¬¡æ•¸</div>
                            <div class="value" style="color: #2196f3;">${results.length}æ¬¡</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}å€</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æœ€ä½å¾—æ¨™</div>
                            <div class="value">${avgMinBid.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡å¾—æ¨™åƒ¹</div>
                            <div class="value">${avgBid.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æº¢åƒ¹ç‡</div>
                            <div class="value" style="color: ${avgPremium >= 0 ? '#dc3545' : '#28a745'};">${avgPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æ›ç‰Œæœ€é«˜</div>
                            <div class="value" style="color: #28a745;">${avgListHigh.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡èœœæœˆæ¼²å¹…</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#28a745' : '#dc3545'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: #fff9c4; border-radius: 6px; font-size: 0.85rem; color: #f57f17;">
                        <strong>ğŸ“Œ èªªæ˜ï¼š</strong>æœ€æ–°æ”¶ç›¤åƒ¹è‹¥é¡¯ç¤ºã€Œ---ã€ä»£è¡¨è©²æª”å¯èƒ½å·²ä¸‹å¸‚æˆ–å°šæœªæ›´æ–°ï¼Œåƒ…ä¾›æ­·å²è³‡æ–™åƒè€ƒ
                    </div>
                </div>
            </div>
            `;
            
            document.getElementById('singleResult').innerHTML = html;
        }

        // ==================== æ‰¹æ¬¡æŸ¥è©¢åŠŸèƒ½ ====================
        function addToBatchList() {
            if (auctionData.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³ Excel è³‡æ–™æª”æ¡ˆ');
                return;
            }

            const input = document.getElementById('batchSearchInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                alert('è«‹è¼¸å…¥æŸ¥è©¢é—œéµå­—');
                return;
            }
            
            if (batchListItems.length >= 20) {
                alert('æœ€å¤šåªèƒ½æŸ¥è©¢20æª”');
                return;
            }
            
            if (batchListItems.includes(keyword)) {
                alert('æ­¤é …ç›®å·²åœ¨åˆ—è¡¨ä¸­');
                input.value = '';
                return;
            }
            
            batchListItems.push(keyword);
            input.value = '';
            input.focus();
            
            updateBatchList();
        }

        function updateBatchList() {
            const listDiv = document.getElementById('batchList');
            const buttonsDiv = document.getElementById('batchButtons');
            
            if (batchListItems.length === 0) {
                listDiv.innerHTML = '';
                buttonsDiv.style.display = 'none';
                return;
            }
            
            buttonsDiv.style.display = 'flex';
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #dee2e6;">';
            html += `<h4 style="color: #495057; margin-bottom: 15px;">ğŸ“‹ å¾…æ¯”è¼ƒåˆ—è¡¨ï¼ˆ${batchListItems.length}/20ï¼‰</h4>`;
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            
            batchListItems.forEach((item, index) => {
                html += `
                    <div style="background: white; padding: 10px 15px; border-radius: 20px; border: 2px solid #667eea; 
                                display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <span style="font-weight: 600; color: #667eea;">${item}</span>
                        <span onclick="removeFromBatchList(${index})" 
                              style="cursor: pointer; color: #dc3545; font-weight: bold; font-size: 1.2rem; 
                                     padding: 0 5px; border-radius: 50%; transition: all 0.3s;"
                              onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                              onmouseout="this.style.background=''; this.style.color='#dc3545';">Ã—</span>
                    </div>
                `;
            });
            
            html += '</div></div>';
            listDiv.innerHTML = html;
        }

        function removeFromBatchList(index) {
            batchListItems.splice(index, 1);
            updateBatchList();
        }

        function clearBatchList() {
            batchListItems = [];
            updateBatchList();
            document.getElementById('batchResult').innerHTML = '';
            document.getElementById('batchChecklist').style.display = 'none';
            document.getElementById('batchSearchInput').focus();
        }

        function executeBatchSearch() {
            if (auctionData.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³ Excel è³‡æ–™æª”æ¡ˆ');
                return;
            }

            if (batchListItems.length === 0) {
                alert('è«‹å…ˆåŠ å…¥æŸ¥è©¢é …ç›®');
                return;
            }
            
            const results = [];
            const notFound = [];
            
            batchListItems.forEach(keyword => {
                const found = auctionData.find(item => 
                    item.stockCode.includes(keyword) || 
                    item.cbCode.includes(keyword) || 
                    item.name.includes(keyword)
                );
                if (found) {
                    results.push(found);
                } else {
                    notFound.push(keyword);
                }
            });

            if (results.length === 0) {
                document.getElementById('batchResult').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #dc3545;">âŒ æŸ¥ç„¡ä»»ä½•è³‡æ–™ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹</div>';
                return;
            }

            displayBatchResult(results, notFound);
        }

        function calculateAggressivePrice(results) {
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            
            let weightSum = 0;
            let weightDetails = [];
            
            results.forEach(item => {
                if (item.secured === 'æœ‰') {
                    weightSum += 0.2;
                    if (!weightDetails.includes('æœ‰æ“”ä¿')) weightDetails.push('æœ‰æ“”ä¿ +0.2%');
                }
                if (item.period === '3å¹´') {
                    weightSum += 0.3;
                    if (!weightDetails.includes('3å¹´æœŸ')) weightDetails.push('3å¹´æœŸ +0.3%');
                }
                if (item.rating >= 3 && item.rating <= 5) {
                    weightSum += 0.5;
                    if (!weightDetails.includes('ä¿¡è©•å„ªè‰¯')) weightDetails.push('ä¿¡è©•å„ªè‰¯(3-5åˆ†) +0.5%');
                }
                if (item.scale >= 3 && item.scale <= 10) {
                    weightSum += 0.2;
                    if (!weightDetails.includes('è¦æ¨¡é©ä¸­')) weightDetails.push('è¦æ¨¡é©ä¸­(3-10å„„) +0.2%');
                }
                const itemGainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                if (itemGainRate > 25) {
                    weightSum += 0.5;
                    if (!weightDetails.includes('å„ªç•°è¡¨ç¾')) weightDetails.push('æ›ç‰Œæ¼²å¹…>25% +0.5%');
                } else if (itemGainRate > 15) {
                    weightSum += 0.3;
                    if (!weightDetails.includes('è‰¯å¥½è¡¨ç¾')) weightDetails.push('æ›ç‰Œæ¼²å¹…>15% +0.3%');
                }
                if (item.atmosphere === 'ğŸ˜Š') {
                    weightSum += 0.2;
                    if (!weightDetails.includes('æº«å’Œæ°›åœ')) weightDetails.push('æŠ•è³‡æ°›åœæº«å’Œ +0.2%');
                }
            });
            
            const avgWeight = weightSum / results.length;
            const aggressivePrice = avgBid * (1 + avgWeight / 100);
            const aggressivePremium = ((aggressivePrice - 100) / 100) * 100;
            
            return {
                price: aggressivePrice,
                premium: aggressivePremium,
                weight: avgWeight,
                details: weightDetails
            };
        }

        function displayBatchResult(results, notFound) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgListLow = results.reduce((sum, item) => sum + item.listLow, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;
            
            const aggressive = calculateAggressivePrice(results);

            let tableHTML = `
                <div style="margin: 30px; overflow-x: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ“‹ æ‰¹æ¬¡æ¯”è¼ƒçµæœï¼šå…± ${results.length} æª”</h3>
                    ${notFound.length > 0 ? `<p style="color: #dc3545; margin-bottom: 15px;">âš ï¸ æœªæ‰¾åˆ°ï¼š${notFound.join(', ')}</p>` : ''}
                    
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>åº</th>
                                <th>ä»£è™Ÿ</th>
                                <th>CBä»£è™Ÿ</th>
                                <th>åç¨±</th>
                                <th>ç”¢æ¥­</th>
                                <th>åˆ¸å•†</th>
                                <th>è¦æ¨¡</th>
                                <th>å¹´æœŸ</th>
                                <th>æ“”ä¿</th>
                                <th>ä¿¡è©•</th>
                                <th>æŠ•æ¨™<br>å€æ•¸</th>
                                <th>æœ€ä½<br>å¾—æ¨™</th>
                                <th>æœ€ä½<br>æº¢åƒ¹</th>
                                <th>å¹³å‡<br>å¾—æ¨™</th>
                                <th>å¹³å‡<br>æº¢åƒ¹</th>
                                <th>æ›ç‰Œ<br>æœ€é«˜</th>
                                <th>æ›ç‰Œ<br>æ¼²å¹…</th>
                                <th>æ°›åœ</th>
                            </tr>
                        </thead>
                        <tbody>`;

            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.stockCode}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}å„„</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === 'æœ‰' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === 'æœ‰' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#28a745' : '#dc3545'};">${gainRate.toFixed(1)}%</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });

            tableHTML += `
                        <tr class="highlight">
                            <td colspan="10" style="text-align: right; padding-right: 20px;">ğŸ“Š ç¶œåˆå¹³å‡å€¼</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#28a745' : '#dc3545'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 20px; font-size: 1.1rem;">ğŸ’¡ æ­·å²æ•¸æ“šåƒè€ƒåˆ†æ</h4>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem;">ğŸ¯ åƒè€ƒæŠ•æ¨™åƒ¹æ ¼å€é–“</h5>
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50;">
                                <strong style="color: #2e7d32;">åƒè€ƒåƒ¹æ ¼Aï¼š</strong>
                                <span style="color: #424242;">${avgMinBid.toFixed(2)}å…ƒï¼ˆæº¢åƒ¹ç‡ ${avgMinPremium.toFixed(2)}%ï¼‰ï¼Œå°æ‡‰æ­·å²æœ€ä½å¾—æ¨™</span>
                            </div>
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                                <strong style="color: #1565c0;">åƒè€ƒåƒ¹æ ¼Bï¼š</strong>
                                <span style="color: #424242;">${avgBid.toFixed(2)}å…ƒï¼ˆæº¢åƒ¹ç‡ ${avgPremium.toFixed(2)}%ï¼‰ï¼Œå°æ‡‰æ­·å²å¹³å‡å¾—æ¨™</span>
                            </div>
                            <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <strong style="color: #e65100;">åƒè€ƒåƒ¹æ ¼Cï¼š</strong>
                                <span style="color: #424242;">${aggressive.price.toFixed(2)}å…ƒï¼ˆæº¢åƒ¹ç‡ ${aggressive.premium.toFixed(2)}%ï¼‰ï¼Œæ™ºèƒ½åŠ æ¬Š +${aggressive.weight.toFixed(2)}%</span>
                                <div style="margin-top: 8px; padding: 8px; background: #ffe0b2; border-radius: 4px; font-size: 0.85rem;">
                                    <strong>ğŸ“Š åŠ æ¬Šå› ç´ ï¼š</strong>${aggressive.details.length > 0 ? aggressive.details.join('ã€') : 'ç„¡ç‰¹æ®Šæœ‰åˆ©æ¢ä»¶'}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #f0f0f0; border-radius: 6px; font-size: 0.85rem;">
                            <strong>ğŸ“ˆ å¹³å‡æŠ•æ¨™å€æ•¸ï¼š</strong>${avgBidMultiple.toFixed(2)}å€
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; font-size: 0.85rem; color: #616161;">
                        <strong>ğŸ“Œ èªªæ˜ï¼š</strong>ä»¥ä¸Šåƒ¹æ ¼åƒ…ç‚ºæ­·å²æ•¸æ“šçµ±è¨ˆåƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚å¯¦éš›æŠ•æ¨™åƒ¹æ ¼è«‹ä¾å€‹äººé¢¨éšªæ‰¿å—åº¦è©•ä¼°ã€‚
                    </div>
                </div>

                <div class="info-card" style="margin-top: 30px;">
                    <h4>ğŸ“Š ç¶œåˆçµ±è¨ˆåˆ†æ</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">æ¯”è¼ƒæª”æ•¸</div>
                            <div class="value" style="color: #2196f3;">${results.length}æª”</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}å€</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æœ€ä½å¾—æ¨™</div>
                            <div class="value">${avgMinBid.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æœ€ä½æº¢åƒ¹ç‡</div>
                            <div class="value" style="color: ${avgMinPremium >= 0 ? '#dc3545' : '#28a745'};">${avgMinPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡å¾—æ¨™åƒ¹</div>
                            <div class="value">${avgBid.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡å¾—æ¨™æº¢åƒ¹ç‡</div>
                            <div class="value" style="color: ${avgPremium >= 0 ? '#dc3545' : '#28a745'};">${avgPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æ›ç‰Œæœ€é«˜</div>
                            <div class="value" style="color: #28a745;">${avgListHigh.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æ›ç‰Œæœ€ä½</div>
                            <div class="value" style="color: #dc3545;">${avgListLow.toFixed(2)}å…ƒ</div>
                        </div>
                        <div class="info-item">
                            <div class="label">å¹³å‡æ›ç‰Œæ¼²å¹…</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#28a745' : '#dc3545'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            document.getElementById('batchResult').innerHTML = tableHTML;
            document.getElementById('batchChecklist').style.display = 'block';
        }

        // ==================== æ¢ä»¶ç¯©é¸åŠŸèƒ½ ====================
        function executeFilterSearch() {
            const filterIndustry = document.getElementById('filterIndustry').value;
            const filterUnderwriter = document.getElementById('filterUnderwriter').value;
            const filterCapital = document.getElementById('filterCapital').value;
            const filterScale = document.getElementById('filterScale').value;
            const filterConvPrice = document.getElementById('filterConvPrice').value;
            const filterRating = document.getElementById('filterRating').value;
            const filterPeriod = document.getElementById('filterPeriod').value;
            const filterSecured = document.getElementById('filterSecured').value;

            const conditions = [filterIndustry, filterUnderwriter, filterCapital, filterScale, filterConvPrice, filterRating, filterPeriod, filterSecured];
            const selectedCount = conditions.filter(c => c !== '').length;

            if (selectedCount < 5) {
                alert('è«‹è‡³å°‘é¸æ“‡5å€‹æ¢ä»¶æ‰èƒ½é€²è¡Œåˆ†æ');
                return;
            }

            selectedFilterConditions = {
                industry: filterIndustry,
                underwriter: filterUnderwriter,
                capital: filterCapital,
                scale: filterScale,
                convPrice: filterConvPrice,
                rating: filterRating,
                period: filterPeriod,
                secured: filterSecured
            };

            localStorage.setItem('filterConditions', JSON.stringify(selectedFilterConditions));

            document.getElementById('filterResult').innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">âœ… æ¢ä»¶å·²å„²å­˜</h4>
                    <p style="color: #155724;">æ‚¨å·²é¸æ“‡ <strong>${selectedCount}</strong> å€‹æ¢ä»¶ï¼Œå¯ä»¥å‰å¾€ã€ŒæŠ•æ¨™è¨ˆç®—æ©Ÿã€é€²è¡Œè©¦ç®—åˆ†æ</p>
                </div>
            `;
        }

        function resetFilters() {
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterUnderwriter').value = '';
            document.getElementById('filterCapital').value = '';
            document.getElementById('filterScale').value = '';
            document.getElementById('filterConvPrice').value = '';
            document.getElementById('filterRating').value = '';
            document.getElementById('filterPeriod').value = '';
            document.getElementById('filterSecured').value = '';
            document.getElementById('filterResult').innerHTML = '';
            selectedFilterConditions = {};
            localStorage.removeItem('filterConditions');
        }

        // ==================== æŠ•æ¨™è¨ˆç®—æ©ŸåŠŸèƒ½ ====================
        function checkCalculatorConditions() {
            const savedConditions = localStorage.getItem('filterConditions');
            const checkDiv = document.getElementById('calculatorCheckConditions');
            const mainDiv = document.getElementById('calculatorMain');

            if (!savedConditions) {
                checkDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 30px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107; text-align: center;">
                        <h4 style="color: #856404; margin-bottom: 15px;">âš ï¸ è«‹å…ˆè¨­å®šç¯©é¸æ¢ä»¶</h4>
                        <p style="color: #856404; margin-bottom: 20px;">æŠ•æ¨™è¨ˆç®—æ©Ÿéœ€è¦å…ˆåœ¨ã€Œæ¢ä»¶ç¯©é¸ã€ä¸­é¸æ“‡è‡³å°‘5å€‹æ¢ä»¶</p>
                        <button class="btn btn-primary" onclick="document.querySelectorAll('.tab')[2].click()">å‰å¾€æ¢ä»¶ç¯©é¸</button>
                    </div>
                `;
                mainDiv.style.display = 'none';
                return;
            }

            const conditions = JSON.parse(savedConditions);
            const conditionCount = Object.values(conditions).filter(v => v !== '').length;

            if (conditionCount < 5) {
                checkDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 30px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107; text-align: center;">
                        <h4 style="color: #856404; margin-bottom: 15px;">âš ï¸ æ¢ä»¶æ•¸é‡ä¸è¶³</h4>
                        <p style="color: #856404; margin-bottom: 20px;">ç›®å‰å·²é¸æ“‡ ${conditionCount} å€‹æ¢ä»¶ï¼Œéœ€è¦è‡³å°‘5å€‹æ¢ä»¶æ‰èƒ½ä½¿ç”¨æŠ•æ¨™è¨ˆç®—æ©Ÿ</p>
                        <button class="btn btn-primary" onclick="document.querySelectorAll('.tab')[2].click()">å‰å¾€è£œå……æ¢ä»¶</button>
                    </div>
                `;
                mainDiv.style.display = 'none';
                return;
            }

            selectedFilterConditions = conditions;
            checkDiv.innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">âœ… æ¢ä»¶æª¢æŸ¥é€šé</h4>
                    <p style="color: #155724; margin: 0;">å·²é¸æ“‡ <strong>${conditionCount}</strong> å€‹æ¢ä»¶ï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨æŠ•æ¨™è¨ˆç®—æ©Ÿ</p>
                </div>
            `;
            mainDiv.style.display = 'block';

            document.getElementById('calcConvPrice').addEventListener('input', calculateTheoretical);
            document.getElementById('calcStockPrice').addEventListener('input', calculateTheoretical);
        }

        function calculateTheoretical() {
            const convPrice = parseFloat(document.getElementById('calcConvPrice').value);
            const stockPrice = parseFloat(document.getElementById('calcStockPrice').value);

            if (convPrice && stockPrice && convPrice > 0) {
                const theoretical = (stockPrice / convPrice) * 100;
                document.getElementById('calcTheoretical').value = theoretical.toFixed(2) + ' å…ƒ';
            } else {
                document.getElementById('calcTheoretical').value = '';
            }
        }

        function analyzePrice() {
            const convPrice = parseFloat(document.getElementById('calcConvPrice').value);
            const stockPrice = parseFloat(document.getElementById('calcStockPrice').value);
            const bidPrice = parseFloat(document.getElementById('calcBidPrice').value);

            if (!convPrice || !stockPrice || !bidPrice) {
                alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            if (convPrice <= 0 || stockPrice <= 0 || bidPrice <= 0) {
                alert('åƒ¹æ ¼å¿…é ˆå¤§æ–¼0');
                return;
            }

            const theoretical = (stockPrice / convPrice) * 100;
            const premium = ((bidPrice - 100) / 100) * 100;

            // é€™è£¡æ‡‰è©²æ ¹æ“šæ¢ä»¶ç¯©é¸æ­·å²è³‡æ–™ï¼Œæš«æ™‚ç”¨å‡æ•¸æ“š
            const historicalAvgMinBid = 108.50;
            const historicalAvgBid = 110.80;
            const historicalAvgMaxBid = 115.20;
            const historicalAvgListHigh = 135.60;
            const historicalCount = 15;

            const diffMinBid = bidPrice - historicalAvgMinBid;
            const diffAvgBid = bidPrice - historicalAvgBid;
            const diffMaxBid = bidPrice - historicalAvgMaxBid;
            const maxCost = bidPrice - 100;
            const costRate = (maxCost / bidPrice) * 100;
            const potentialProfit = historicalAvgListHigh - bidPrice;
            const profitRate = (potentialProfit / bidPrice) * 100;

            currentAnalysisData = {
                convPrice, stockPrice, bidPrice, theoretical, premium,
                historicalAvgMinBid, historicalAvgBid, historicalAvgMaxBid, historicalAvgListHigh,
                historicalCount, diffMinBid, diffAvgBid, diffMaxBid, maxCost, costRate,
                potentialProfit, profitRate, conditions: selectedFilterConditions
            };

            displayAnalysisResult();
        }

        function displayAnalysisResult() {
            const data = currentAnalysisData;

            let html = `
                <div class="result-box" style="margin-top: 30px;">
                    <h3 style="color: #1976d2; margin-bottom: 20px;">ğŸ“Š æ­·å²æ•¸æ“šå°æ¯”åˆ†æ</h3>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">æ‚¨è¼¸å…¥çš„åƒ¹æ ¼</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">æŠ•æ¨™åƒ¹æ ¼</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #667eea;">${data.bidPrice.toFixed(2)}å…ƒ</div>
                            </div>
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">æº¢åƒ¹ç‡</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: ${data.premium >= 0 ? '#dc3545' : '#28a745'};">${data.premium.toFixed(2)}%</div>
                            </div>
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">ç†è«–åƒ¹å€¼</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #495057;">${data.theoretical.toFixed(2)}å…ƒ</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">ç¬¦åˆæ¢ä»¶çš„æ­·å²æ¨™çš„ï¼ˆå…±${data.historicalCount}æª”ï¼‰çµ±è¨ˆ</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">å¹³å‡æœ€ä½å¾—æ¨™</span>
                                <span style="font-weight: 600;">${data.historicalAvgMinBid.toFixed(2)}å…ƒ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">å¹³å‡å¾—æ¨™åƒ¹</span>
                                <span style="font-weight: 600;">${data.historicalAvgBid.toFixed(2)}å…ƒ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">å¹³å‡æœ€é«˜å¾—æ¨™</span>
                                <span style="font-weight: 600;">${data.historicalAvgMaxBid.toFixed(2)}å…ƒ</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">åƒ¹å·®çµ±è¨ˆ</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs å¹³å‡æœ€ä½</span>
                                <span style="font-weight: 600; color: ${data.diffMinBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffMinBid >= 0 ? '+' : ''}${data.diffMinBid.toFixed(2)}å…ƒ (${((data.diffMinBid/data.historicalAvgMinBid)*100).toFixed(1)}%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs å¹³å‡åƒ¹</span>
                                <span style="font-weight: 600; color: ${data.diffAvgBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffAvgBid >= 0 ? '+' : ''}${data.diffAvgBid.toFixed(2)}å…ƒ (${((data.diffAvgBid/data.historicalAvgBid)*100).toFixed(1)}%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs å¹³å‡æœ€é«˜</span>
                                <span style="font-weight: 600; color: ${data.diffMaxBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffMaxBid >= 0 ? '+' : ''}${data.diffMaxBid.toFixed(2)}å…ƒ (${((data.diffMaxBid/data.historicalAvgMaxBid)*100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">åƒ¹æ ¼åˆ†å¸ƒåƒè€ƒ</h4>
                        <div class="price-chart">
                            <div class="price-line">${data.historicalAvgMaxBid.toFixed(2)}å…ƒ â”â”â” æ­·å²å¹³å‡æœ€é«˜å¾—æ¨™</div>
                            <div class="your-price-line">${data.bidPrice.toFixed(2)}å…ƒ â—â”â” æ‚¨çš„æŠ•æ¨™åƒ¹</div>
                            <div class="price-line">${data.historicalAvgBid.toFixed(2)}å…ƒ â”â”â” æ­·å²å¹³å‡å¾—æ¨™åƒ¹</div>
                            <div class="price-line">${data.historicalAvgMinBid.toFixed(2)}å…ƒ â”â”â” æ­·å²å¹³å‡æœ€ä½å¾—æ¨™</div>
                            <div class="price-line">100.00å…ƒ â”â”â” åº•æ¨™åŸºæº–</div>
                        </div>
                        <p style="text-align: center; color: #6c757d; font-size: 0.85rem; margin-top: 10px;">èªªæ˜ï¼šåƒ…å‘ˆç¾åƒ¹æ ¼ä½ç½®ï¼Œä¸ä»£è¡¨è©•åƒ¹</p>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">ğŸ’° æˆæœ¬é¢¨éšªè©¦ç®—</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">æŠ•æ¨™åƒ¹æ ¼</span>
                                <span style="font-weight: 600;">${data.bidPrice.toFixed(2)}å…ƒ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                <span style="color: #856404;">æœ€å¤§æˆæœ¬</span>
                                <span style="font-weight: 600; color: #dc3545;">${data.maxCost.toFixed(2)}å…ƒï¼ˆæŠ•æ¨™åƒ¹-100å…ƒï¼‰</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">æˆæœ¬ç‡</span>
                                <span style="font-weight: 600; color: #dc3545;">${data.costRate.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“ˆ æ©Ÿæœƒè©•ä¼°</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #d4edda; border-radius: 4px;">
                                <span style="color: #155724;">è‹¥é”æ­·å²å¹³å‡æ›ç‰Œæœ€é«˜ï¼ˆ${data.historicalAvgListHigh.toFixed(2)}å…ƒï¼‰</span>
                                <span style="font-weight: 600; color: #28a745;">+${data.potentialProfit.toFixed(2)}å…ƒ (+${data.profitRate.toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportReport('txt')">ğŸ“„ åŒ¯å‡ºç´”æ–‡å­—</button>
                        <button class="btn btn-primary" onclick="exportReport('html')">ğŸ“‹ åŒ¯å‡ºHTML</button>
                        <button class="btn btn-primary" onclick="exportReport('pdf')">ğŸ“¥ åŒ¯å‡ºPDF</button>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 0.9rem; color: #856404;">
                        <strong>ğŸ’¡ èªªæ˜ï¼š</strong>æ‰€æœ‰æ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œè©•ä¼°é¢¨éšªã€‚
                    </div>
                </div>
            `;

            document.getElementById('calculatorResult').innerHTML = html;
        }

        function exportReport(format) {
            if (!currentAnalysisData) {
                alert('è«‹å…ˆé€²è¡Œåƒ¹æ ¼åˆ†æ');
                return;
            }

            switch(format) {
                case 'txt':
                    exportTextReport();
                    break;
                case 'html':
                    alert('HTMLå ±å‘ŠåŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­');
                    break;
                case 'pdf':
                    alert('PDFå ±å‘ŠåŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­');
                    break;
            }
        }

        function exportTextReport() {
            const data = currentAnalysisData;
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW');
            const timeStr = now.toLocaleTimeString('zh-TW');

            const report = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        å¯è½‰å‚µæŠ•æ¨™è©¦ç®—åˆ†æå ±å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å ±å‘Šç”¢ç”Ÿæ™‚é–“ï¼š${dateStr} ${timeStr}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸€ã€åŸºæœ¬è³‡æ–™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è½‰æ›åƒ¹æ ¼ï¼š${data.convPrice.toFixed(2)}å…ƒ
è‚¡ç¥¨å¸‚åƒ¹ï¼š${data.stockPrice.toFixed(2)}å…ƒ
ç†è«–åƒ¹å€¼ï¼š${data.theoretical.toFixed(2)}å…ƒ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
äºŒã€æŠ•æ¨™åƒ¹æ ¼åˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ‚¨çš„æŠ•æ¨™åƒ¹æ ¼ï¼š${data.bidPrice.toFixed(2)}å…ƒï¼ˆæº¢åƒ¹ç‡ ${data.premium.toFixed(2)}%ï¼‰

æ­·å²æ•¸æ“šå°æ¯”ï¼š
vs å¹³å‡æœ€ä½å¾—æ¨™ï¼š${data.diffMinBid >= 0 ? '+' : ''}${data.diffMinBid.toFixed(2)}å…ƒ
vs å¹³å‡å¾—æ¨™åƒ¹ï¼š${data.diffAvgBid >= 0 ? '+' : ''}${data.diffAvgBid.toFixed(2)}å…ƒ
vs å¹³å‡æœ€é«˜å¾—æ¨™ï¼š${data.diffMaxBid >= 0 ? '+' : ''}${data.diffMaxBid.toFixed(2)}å…ƒ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸‰ã€é¢¨éšªè©•ä¼°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æœ€å¤§æˆæœ¬ï¼š${data.maxCost.toFixed(2)}å…ƒ
æˆæœ¬ç‡ï¼š${data.costRate.toFixed(2)}%
æ½›åœ¨ç²åˆ©ï¼š+${data.potentialProfit.toFixed(2)}å…ƒ (+${data.profitRate.toFixed(1)}%)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ å…è²¬è²æ˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æœ¬å ±å‘Šåƒ…æä¾›æ­·å²æ•¸æ“šçµ±è¨ˆèˆ‡è©¦ç®—åƒè€ƒ
æ‰€æœ‰æ•¸æ“šä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°
æŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œè©•ä¼°é¢¨éšª

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è³‡æ–™ä¾†æºï¼šRexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¯è½‰å‚µæŠ•æ¨™è©¦ç®—å ±å‘Š_${dateStr.replace(/\//g, '')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            displayCurrentDate();
            updateDataPeriodInfo();
            
            const saved = localStorage.getItem('investorType');
            if (saved) {
                currentInvestorType = saved;
                const radio = document.querySelector(`input[name="investorType"][value="${saved}"]`);
                if (radio) radio.checked = true;
            }

            const savedConditions = localStorage.getItem('filterConditions');
            if (savedConditions) {
                selectedFilterConditions = JSON.parse(savedConditions);
            }
        };
    </script>
</body>
</html>
