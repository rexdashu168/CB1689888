<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可轉債競拍查詢系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 2rem; 
            margin-bottom: 10px; 
            font-weight: 600; 
        }
        .header p { 
            font-size: 0.95rem; 
            opacity: 0.9; 
        }
        .header-info { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            margin-top: 15px; 
            flex-wrap: wrap; 
        }
        .header-info-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem; 
            background: rgba(255, 255, 255, 0.2); 
            padding: 8px 16px; 
            border-radius: 20px; 
            transition: all 0.3s ease; 
            cursor: pointer; 
        }
        .header-info-item:hover { 
            background: rgba(255, 255, 255, 0.35); 
            transform: translateY(-2px); 
        }

        .data-update-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
            padding: 12px 30px;
            text-align: center;
            color: #e65100;
            font-size: 0.9rem;
            border-bottom: 2px solid #ffcc80;
        }

        .tabs { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 3px solid #dee2e6; 
        }
        .tab { 
            flex: 1; 
            padding: 12px 10px; 
            text-align: center; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            border-bottom: 3px solid transparent; 
            margin-bottom: -3px; 
            line-height: 1.3;
        }
        .tab:hover { 
            background: #e9ecef; 
        }
        .tab.active { 
            background: white; 
            border-bottom: 3px solid #667eea; 
            color: #667eea; 
        }
        
        .tab-content { 
            display: none; 
            padding: 30px; 
        }
        .tab-content.active { 
            display: block; 
        }
        
        .search-box { 
            max-width: 600px; 
            margin: 50px auto; 
            text-align: center; 
        }
        .search-box input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            border: 3px solid #667eea; 
            border-radius: 10px; 
        }
        .search-box input:focus { 
            outline: none; 
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); 
        }
        .search-hint { 
            color: #6c757d; 
            margin-top: 15px; 
            font-size: 0.9rem; 
        }
        
        .btn { 
            padding: 12px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 600; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); 
        }
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        .btn-secondary:hover { 
            background: #5a6268; 
            transform: translateY(-2px); 
        }
        
        .stats-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            background: white; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-size: 0.85rem;
        }
        .stats-table th { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 8px; 
            text-align: center; 
            font-size: 0.8rem; 
            border: 1px solid rgba(255,255,255,0.2); 
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .stats-table th:hover {
            background: linear-gradient(135deg, #7c8ef0 0%, #8a5bb2 100%);
        }
        .stats-table th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
            font-size: 0.75rem;
            margin-left: 3px;
        }
        .stats-table th.sort-asc::after {
            content: ' ▲';
            opacity: 1;
            color: #ffd700;
            font-size: 0.75rem;
            margin-left: 3px;
        }
        .stats-table th.sort-desc::after {
            content: ' ▼';
            opacity: 1;
            color: #ffd700;
            font-size: 0.75rem;
            margin-left: 3px;
        }
        .stats-table td { 
            padding: 10px 8px; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            font-size: 0.8rem; 
        }
        .stats-table tr:nth-child(even) { 
            background: #f8f9fa; 
        }
        .stats-table tr:hover { 
            background: #e7f3ff; 
        }
        .stats-table .highlight { 
            background: #fff3cd !important; 
            font-weight: 600; 
        }
        
        .info-card { 
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 4px solid #667eea; 
            margin-bottom: 20px; 
        }
        .info-card h4 { 
            color: #667eea; 
            margin-bottom: 15px; 
            font-size: 1.1rem; 
        }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
        }
        .info-item { 
            padding: 10px; 
            background: white; 
            border-radius: 6px; 
            text-align: center; 
        }
        .info-item .label { 
            font-size: 0.8rem; 
            color: #6c757d; 
            margin-bottom: 5px; 
        }
        .info-item .value { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: #495057; 
        }
        
        .positive { color: #dc3545; }  /* 台灣習慣:紅色代表溢價/上漲 */
        .negative { color: #28a745; }  /* 台灣習慣:綠色代表折價/下跌 */
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .investor-type-selector {
            background: linear-gradient(135deg, #e8eaf6 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #5c6bc0;
        }
        
        .radio-group {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .type-descriptions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .type-desc-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #5c6bc0;
        }
        
        .type-desc-card h5 {
            color: #5c6bc0;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .type-desc-card p {
            font-size: 0.85rem;
            color: #616161;
            line-height: 1.6;
        }
        
        .warning-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-banner h4 {
            color: #d32f2f;
            margin-bottom: 10px;
        }
        
        .warning-banner p {
            color: #424242;
            line-height: 1.8;
            margin: 5px 0;
        }

        .calculator-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .calculator-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .price-chart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .price-line {
            padding: 8px 0;
        }

        .your-price-line {
            background: #fff3cd;
            font-weight: 600;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 5px 0;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .collapsible {
            background: #e3f2fd;
            cursor: pointer;
            padding: 15px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #1565c0;
        }

        .collapsible:hover {
            background: #bbdefb;
        }

        .collapsible-content {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .collapsible-content.active {
            display: block;
        }

        .footer { 
            padding: 20px 30px; 
            background: #f8f9fa; 
            border-top: 2px solid #e9ecef; 
            text-align: center; 
            color: #6c757d; 
            font-size: 0.85rem; 
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .tab { font-size: 0.9rem; padding: 15px 10px; }
            .radio-group { flex-direction: column; gap: 15px; }
            .calculator-input-group { grid-template-columns: 1fr; }
            .export-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 可轉債競拍查詢系統</h1>
            <p style="margin-bottom: 15px;">競拍統計數據 | 智能模擬分析 | 投標價格試算</p>
            <div class="header-info">
                <div class="header-info-item"><span>📅</span><span id="currentDate">載入中...</span></div>
                <div class="header-info-item" onclick="window.open('https://vocus.cc/salon/655c9dbcfd897800019d5bb4', '_blank')"><span>📝</span><span>方格子部落格</span></div>
                <div class="header-info-item" onclick="window.open('https://www.youtube.com/@rexdashu168', '_blank')"><span>🎬</span><span>YouTube頻道</span></div>
            </div>
            <p style="margin-top: 12px; font-size: 0.85rem; opacity: 0.85;">by Rex大叔的168台股投資教室</p>
        </div>

        <div class="data-update-banner" id="dataUpdateBanner">
            📅 正在載入競拍資料...
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('single')">🔍<br>單檔查詢</div>
            <div class="tab" onclick="switchTab('batch')">📊<br>批次查詢</div>
            <div class="tab" onclick="switchTab('filter')">⚙️<br>條件篩選</div>
            <div class="tab" onclick="switchTab('calculator')">🎯<br>投標計算機</div>
        </div>

        <!-- Tab 1: 單檔查詢 -->
        <div id="tab-single" class="tab-content active">
            <div class="search-box">
                <h2 style="margin-bottom: 20px; color: #495057;">🔍 單檔歷史查詢</h2>
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #2196f3; text-align: left;">
                    <h4 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>💡</span><span>功能說明</span>
                    </h4>
                    <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                        <p style="margin-bottom: 8px;"><strong>查詢方式：</strong>輸入股票代號、CB代號或公司名稱</p>
                        <p style="margin-bottom: 8px;"><strong>顯示內容：</strong>該公司所有歷次發行的可轉債競拍記錄</p>
                        <p style="margin-bottom: 0;"><strong>使用範例：</strong>輸入「3617」或「碩天」，呈現完整該公司歷史競拍資料</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center; max-width: 600px; margin: 0 auto;">
                    <input type="text" id="singleSearchInput" placeholder="輸入股票代號、CB代號或公司名稱" 
                        onkeyup="if(event.key==='Enter') executeSingleSearch()">
                    <button class="btn btn-primary" onclick="executeSingleSearch()">查詢</button>
                </div>
                <p class="search-hint">查詢該公司所有可轉債競拍歷史記錄</p>
            </div>
            <div id="singleResult"></div>
        </div>

        <!-- Tab 2: 批次查詢 -->
        <div id="tab-batch" class="tab-content">
            <div class="search-box">
                <h2 style="margin-bottom: 20px; color: #495057;">📊 批次比較查詢</h2>
                
                <!-- 時間區間篩選 -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>📅</span><span>時間區間快速查詢</span>
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="queryByTimeRange(1)" style="font-size: 0.9rem; padding: 10px;">最近1個月</button>
                        <button class="btn btn-primary" onclick="queryByTimeRange(3)" style="font-size: 0.9rem; padding: 10px;">最近3個月</button>
                        <button class="btn btn-primary" onclick="queryByTimeRange(6)" style="font-size: 0.9rem; padding: 10px;">最近半年</button>
                        <button class="btn btn-primary" onclick="queryByTimeRange(12)" style="font-size: 0.9rem; padding: 10px;">最近1年</button>
                        <button class="btn btn-primary" onclick="queryByTimeRange(24)" style="font-size: 0.9rem; padding: 10px;">最近2年</button>
                        <button class="btn btn-primary" onclick="queryByTimeRange(36)" style="font-size: 0.9rem; padding: 10px;">最近3年</button>
                    </div>
                    <p style="color: #616161; font-size: 0.85rem; margin: 0;">點擊按鈕自動載入該期間所有競拍標的進行統計分析</p>
                </div>

                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #ff9800; text-align: left;">
                    <h4 style="color: #e65100; margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>💡</span><span>手動加入查詢</span>
                    </h4>
                    <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                        <p style="margin-bottom: 8px;"><strong>查詢方式：</strong>自由加入多檔不同標的進行比較分析（最多20檔）</p>
                        <p style="margin-bottom: 8px;"><strong>顯示內容：</strong>綜合統計表、智能投標建議（保守/穩健/積極）</p>
                        <p style="margin-bottom: 0;"><strong>適合用於：</strong>比較不同公司、評估投資組合、制定投標策略</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center; max-width: 600px; margin: 0 auto;">
                    <input type="text" id="batchSearchInput" placeholder="輸入代號或名稱後按Enter加入" 
                        onkeyup="if(event.key==='Enter') addToBatchList()">
                    <button class="btn btn-primary" onclick="addToBatchList()">加入</button>
                </div>
                <p class="search-hint">逐筆加入不同標的，建立自己的比較清單</p>
                
                <div id="batchList" style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;"></div>
                
                <div id="batchButtons" style="display: none; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="executeBatchSearch()">🔍 開始分析</button>
                    <button class="btn btn-secondary" onclick="clearBatchList()">🗑️ 清空列表</button>
                </div>
            </div>
            <div id="batchResult"></div>
            
            <div id="batchChecklist" style="display: none;">
                <div style="background: linear-gradient(135deg, #e8eaf6 0%, #ffffff 100%); padding: 25px; margin: 20px 30px; border-radius: 10px; border-left: 4px solid #5c6bc0;">
                    <h3 style="color: #3f51b5; margin-bottom: 15px;">📋 投標前參考檢查清單</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">⏰ 時機選擇</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                ✓ 截標日1:30收盤後再投標<br>
                                ✓ 避免價格波動期間決策<br>
                                ✓ 計算「靜止的理論價格」
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">💰 風險評估</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                ✓ 計算最大損失：投標價-100元<br>
                                ✓ 評估可承受的風險金額<br>
                                ✓ 考慮信評、擔保、年期
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">📊 數據參考</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                ✓ 參考歷史平均得標價<br>
                                ✓ 觀察投標倍數（投資氛圍）<br>
                                ✓ 比較同類標的表現
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="color: #d32f2f; font-weight: 600; margin-bottom: 8px;">⚠️ 重要提醒</div>
                            <div style="font-size: 0.85rem; color: #616161; line-height: 1.6;">
                                ✓ 投標後無法取消（僅能棄標）<br>
                                ✓ 投完標務必再次檢查<br>
                                ✓ 確保交割資金充足
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; font-size: 0.9rem; color: #856404;">
                        <strong>💡 Rex大叔提醒：</strong>專注於風險控制，不追求暴利。目標是以最接近最低得標價拍到，控制成本才是長期獲利的關鍵。
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: 條件篩選 -->
        <div id="tab-filter" class="tab-content">
            <h2 style="color: #495057; margin-bottom: 20px;">⚙️ 條件篩選分析</h2>
            
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #2196f3;">
                <h4 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <span>💡</span><span>功能說明</span>
                </h4>
                <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                    <p style="margin-bottom: 8px;"><strong>獨立分析：</strong>此功能可獨立使用，直接顯示符合條件的歷史資料統計</p>
                    <p style="margin-bottom: 8px;"><strong>輔助計算機：</strong>分析結果可作為「投標計算機」的參考數據來源</p>
                    <p style="margin-bottom: 0;"><strong>使用建議：</strong>先在此設定條件查看歷史統計，再到投標計算機試算價格</p>
                </div>
            </div>
            
            <div class="filter-section">
                <h3 style="color: #495057; margin-bottom: 20px;">篩選條件設定（請至少選擇3個條件）</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="filter-group">
                        <label>🏭 產業分類</label>
                        <select id="filterIndustry">
                            <option value="">全部</option>
                            <option value="化學工業">化學工業</option>
                            <option value="航運業">航運業</option>
                            <option value="資訊服務業">資訊服務業</option>
                            <option value="其他電子業">其他電子業</option>
                            <option value="油電燃氣業">油電燃氣業</option>
                            <option value="農業科技業">農業科技業</option>
                            <option value="文化創意業">文化創意業</option>
                            <option value="生技醫療業">生技醫療業</option>
                            <option value="建材營造業">建材營造業</option>
                            <option value="電子零組件業">電子零組件業</option>
                            <option value="電腦及週邊設備業">電腦及週邊設備業</option>
                            <option value="電機機械">電機機械</option>
                            <option value="半導體業">半導體業</option>
                            <option value="證券業">證券業</option>
                            <option value="運動休閒">運動休閒</option>
                            <option value="光電業">光電業</option>
                            <option value="綠能環保">綠能環保</option>
                            <option value="電器電纜">電器電纜</option>
                            <option value="其他業">其他業</option>
                            <option value="通信網路業">通信網路業</option>
                            <option value="電子通路業">電子通路業</option>
                            <option value="觀光餐旅">觀光餐旅</option>
                            <option value="貿易百貨業">貿易百貨業</option>
                            <option value="鋼鐵工業">鋼鐵工業</option>
                            <option value="汽車工業">汽車工業</option>
                            <option value="居家生活">居家生活</option>
                            <option value="造紙工業">造紙工業</option>
                            <option value="塑膠工業">塑膠工業</option>
                            <option value="紡織纖維">紡織纖維</option>
                            <option value="食品工業">食品工業</option>
                            <option value="數位雲端">數位雲端</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>🏢 發行券商</label>
                        <select id="filterUnderwriter">
                            <option value="">全部</option>
                            <option value="統一證券">統一證券</option>
                            <option value="第一金證">第一金證</option>
                            <option value="國票證券">國票證券</option>
                            <option value="富邦證券">富邦證券</option>
                            <option value="永豐金證">永豐金證</option>
                            <option value="凱基證券">凱基證券</option>
                            <option value="台新證券">台新證券</option>
                            <option value="中信證券">中信證券</option>
                            <option value="群益證券">群益證券</option>
                            <option value="台中銀證">台中銀證</option>
                            <option value="元大證券">元大證券</option>
                            <option value="國泰證券">國泰證券</option>
                            <option value="華南永昌">華南永昌</option>
                            <option value="合庫證券">合庫證券</option>
                            <option value="福邦證券">福邦證券</option>
                            <option value="兆豐證券">兆豐證券</option>
                            <option value="宏遠證券">宏遠證券</option>
                            <option value="永豐證券">永豐證券</option>
                            <option value="康和證券">康和證券</option>
                            <option value="元富證券">元富證券</option>
                            <option value="玉山證券">玉山證券</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>📊 股本區間</label>
                        <select id="filterCapital">
                            <option value="">全部</option>
                            <option value="<3">小於3億</option>
                            <option value="3-6">3~6億</option>
                            <option value="6-10">6~10億</option>
                            <option value="10-15">10~15億</option>
                            <option value="15-20">15~20億</option>
                            <option value=">20">20億以上</option>
                            <option value="<10">小於10億</option>
                            <option value=">10">大於10億</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>💰 發行規模</label>
                        <select id="filterScale">
                            <option value="">全部</option>
                            <option value="<2">小於2億</option>
                            <option value="2-3">2~3億</option>
                            <option value="3-6">3~6億</option>
                            <option value="6-10">6~10億</option>
                            <option value="10-15">10~15億</option>
                            <option value="15-20">15~20億</option>
                            <option value=">20">20億以上</option>
                            <option value="<5">5億以下</option>
                            <option value=">5">5億以上</option>
                            <option value="<10">10億以下</option>
                            <option value=">10">10億以上</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>💵 轉換價格</label>
                        <select id="filterConvPrice">
                            <option value="">全部</option>
                            <option value="<20">20元以下</option>
                            <option value="20-50">20~50元</option>
                            <option value="50-100">50~100元</option>
                            <option value="100-150">100~150元</option>
                            <option value="150-200">150~200元</option>
                            <option value=">200">200元以上</option>
                            <option value="<50">50元以下</option>
                            <option value=">50">50元以上</option>
                            <option value="<100">100元以下</option>
                            <option value=">100">100元以上</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>⭐ TCRI信用評等</label>
                        <select id="filterRating">
                            <option value="">全部</option>
                            <option value="2">2分</option>
                            <option value="3">3分</option>
                            <option value="4">4分</option>
                            <option value="5">5分</option>
                            <option value="6">6分</option>
                            <option value="7">7分</option>
                            <option value="8">8分</option>
                            <option value="9">9分</option>
                            <option value="<=4">4分以下（含）</option>
                            <option value=">=5">5分以上（含）</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>📅 發行年期</label>
                        <select id="filterPeriod">
                            <option value="">全部</option>
                            <option value="3">3年</option>
                            <option value="5">5年</option>
                            <option value="7">7年</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>🛡️ 擔保情況</label>
                        <select id="filterSecured">
                            <option value="">全部</option>
                            <option value="有">有擔保</option>
                            <option value="無">無擔保</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="executeFilterSearch()">🔍 開始分析</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">🔄 重置條件</button>
                </div>
            </div>
            
            <div id="filterResult"></div>
        </div>

        <!-- Tab 4: 投標計算機 -->
        <div id="tab-calculator" class="tab-content">
            <h2 style="color: #495057; margin-bottom: 20px; text-align: center;">🎯 投標計算機</h2>
            
            <button class="collapsible" onclick="toggleCollapsible(this)">📖 使用說明（點擊展開）</button>
            <div class="collapsible-content">
                <h4 style="color: #1976d2; margin-bottom: 12px;">💡 功能說明</h4>
                <div style="line-height: 1.8; color: #424242;">
                    <p><strong>1️⃣</strong> 請先到「條件篩選」選擇至少5個條件</p>
                    <p><strong>2️⃣</strong> 輸入轉換價格和股票市價計算理論價值</p>
                    <p><strong>3️⃣</strong> 輸入您想投標的價格</p>
                    <p><strong>4️⃣</strong> 系統會分析與歷史數據的差異</p>
                    <p><strong>5️⃣</strong> 可進行情境比較與匯出報告</p>
                    <p style="margin-top: 10px; color: #856404; background: #fff3cd; padding: 10px; border-radius: 6px;">
                        <strong>⚠️ 重要：</strong>所有分析結果僅供參考，不構成投資建議
                    </p>
                </div>
            </div>

            <!-- 投標風險提醒 -->
            <div style="background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin: 20px 0 30px 0; border-left: 4px solid #f44336;">
                <h4 style="color: #c62828; margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                    <span>⚠️</span><span>投標重要提醒</span>
                </h4>
                <div style="color: #424242; font-size: 0.9rem; line-height: 1.8; text-align: left;">
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">📌 投標不可取消：</strong>投標後無法取消，請謹慎填寫價格</p>
                        
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">💰 保證金規定：</strong></p>
                        <p style="margin-bottom: 8px; padding-left: 20px;">• 保證金 = 投標總價金 × 50%</p>
                        <p style="margin-bottom: 10px; padding-left: 20px; background: #fff9c4; padding: 8px; border-radius: 4px;">
                            <strong>範例：</strong>投標1張、價格105元<br>
                            → 保證金 = 1張 × 105,000元 × 50% = <strong>52,500元</strong>
                        </p>
                        
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">❌ 得標未交割：</strong>若得標後尾款未繳交，<strong>保證金將被沒收</strong></p>
                        
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">💵 標單處理費：</strong></p>
                        <p style="margin-bottom: 8px; padding-left: 20px;">• 每筆標單處理費 <strong>400元</strong></p>
                        <p style="margin-bottom: 10px; padding-left: 20px; background: #fff9c4; padding: 8px; border-radius: 4px;">
                            <strong>範例：</strong>寫3個不同價格 = 3筆標單 = <strong>1,200元</strong>處理費
                        </p>
                        
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">📊 張數上限：</strong>每檔可轉債有投標張數上限，<strong>需注意公告規定</strong></p>
                        
                        <p style="margin-bottom: 10px;"><strong style="color: #d32f2f;">🔖 得標手續費：</strong></p>
                        <p style="margin-bottom: 0; padding-left: 20px;">• 得標手續費 = 得標總價金 × (0.5% 或 1%)</p>
                        <p style="padding-left: 20px; margin-top: 4px; font-size: 0.85rem; color: #616161;">
                            ※ 手續費率依各券商公告而定，通常為 0.5% 或 1%
                        </p>
                    </div>
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 3px solid #fbc02d;">
                        <strong style="color: #f57f17;">💡 重要建議：</strong>謹慎評估資金需求，避免因未交割而損失保證金
                    </div>
                </div>
            </div>

            <div id="calculatorCheckConditions"></div>
            <div id="calculatorMain" style="display: none;">
                <div class="calculator-section">
                    <h3 style="color: #495057; margin-bottom: 20px;">📊 理論價值計算</h3>
                    <div class="calculator-input-group">
                        <div class="filter-group">
                            <label>轉換價格（元）</label>
                            <input type="number" id="calcConvPrice" placeholder="例如：44.00" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label>股票市價（元）- 截標日1:30收盤價</label>
                            <input type="number" id="calcStockPrice" placeholder="例如：41.20" step="0.01">
                        </div>
                        <div class="filter-group">
                            <label>理論價值（自動計算）</label>
                            <input type="text" id="calcTheoretical" readonly style="background: #e9ecef; font-weight: 600;">
                        </div>
                    </div>
                </div>

                <div class="calculator-section">
                    <h3 style="color: #495057; margin-bottom: 20px;">🎯 投標價格試算</h3>
                    <div class="calculator-input-group">
                        <div class="filter-group">
                            <label>您想投標的價格（元）</label>
                            <input type="number" id="calcBidPrice" placeholder="例如：112.00" step="0.01">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="analyzePrice()">🔍 開始分析</button>
                    </div>
                </div>

                <div id="calculatorResult"></div>
            </div>
        </div>

        <div class="warning-banner">
            <h4>⚠️ 重要提示</h4>
            <p>本系統提供歷史數據統計與資料整理，所有數據僅供參考，不構成任何投資建議</p>
            <p>過去表現不代表未來結果，投資決策請自行評估風險</p>
        </div>

        <div class="footer">
            <p style="font-weight: 500;">資料來源：證券櫃檯買賣中心</p>
            <p style="margin-top: 8px; color: #f44336; font-weight: 500;">⚠️ 本表僅供參考，投資決策請自行評估風險</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">📚 Rex大叔的168台股投資教室</p>
                <p style="font-size: 0.85rem; color: #6c757d;">更多投資觀念與可轉債分析，歡迎訂閱學習</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== 表格排序功能 ====================
        let currentSortColumn = {};
        let currentSortOrder = {};
        
        // 使用事件委託，點擊任何表格的th都會觸發排序
        document.addEventListener('click', function(e) {
            const th = e.target.closest('th.sortable');
            if (!th) return;
            
            const table = th.closest('table');
            const tableId = table.id || 'table_' + Date.now();
            table.id = tableId;
            
            const tbody = table.querySelector('tbody');
            const columnIndex = Array.from(th.parentElement.children).indexOf(th);
            
            sortTable(tbody, columnIndex, th, tableId);
        });
        
        function sortTable(tbody, columnIndex, header, tableId) {
            const rows = Array.from(tbody.querySelectorAll('tr:not(.highlight)'));
            const isAscending = currentSortColumn[tableId] === columnIndex ? currentSortOrder[tableId] === 'desc' : true;
            
            // 移除所有表頭的排序標記
            const allHeaders = tbody.closest('table').querySelectorAll('thead th');
            allHeaders.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            
            // 排序行
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim();
                let bValue = b.cells[columnIndex].textContent.trim();
                
                // 移除百分號、逗號、億等符號
                aValue = aValue.replace(/[%,億]/g, '');
                bValue = bValue.replace(/[%,億]/g, '');
                
                // 嘗試轉換為數字
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                let comparison = 0;
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    comparison = aNum - bNum;
                } else {
                    comparison = aValue.localeCompare(bValue, 'zh-TW');
                }
                
                return isAscending ? comparison : -comparison;
            });
            
            // 重新插入排序後的行
            rows.forEach(row => tbody.appendChild(row));
            
            // 將統計行（highlight）移到最後
            const highlightRows = tbody.querySelectorAll('tr.highlight');
            highlightRows.forEach(row => tbody.appendChild(row));
            
            // 更新排序標記
            header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
            currentSortColumn[tableId] = columnIndex;
            currentSortOrder[tableId] = isAscending ? 'asc' : 'desc';
        }
        
        // 為表格的th添加sortable class
        function enableTableSort() {
            document.querySelectorAll('.stats-table thead th').forEach((th, index) => {
                // 跳過已經有sortable的
                if (th.classList.contains('sortable')) return;
                
                // 跳過不需要排序的欄位
                const text = th.textContent.trim();
                if (text.includes('序') || text.includes('氛圍')) {
                    return;
                }
                th.classList.add('sortable');
            });
        }
        
        // 使用MutationObserver監測DOM變化，自動為新表格啟用排序
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length) {
                    enableTableSort();
                }
            });
        });
        
        // 開始監測
        document.addEventListener('DOMContentLoaded', function() {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            enableTableSort(); // 初始執行一次
        });
        
        // ==================== 全域變數 ====================
        let auctionData = [];
        let batchListItems = [];
        let currentInvestorType = 'conservative';
        let selectedFilterConditions = {};
        let currentAnalysisData = null;

        // ==================== 自動載入 Excel 資料 ====================
        async function loadExcelData() {
            try {
                // 顯示載入中訊息
                document.getElementById('dataUpdateBanner').innerHTML = '📅 正在載入競拍資料...';
                document.getElementById('dataUpdateBanner').style.background = 'linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%)';
                document.getElementById('dataUpdateBanner').style.color = '#1976d2';
                
                console.log('[載入] 開始載入 Excel 檔案...');
                
                // 加上時間戳記避免快取問題
                const timestamp = new Date().getTime();
                const response = await fetch(`auction_data.xlsx?t=${timestamp}`);
                console.log('[載入] HTTP狀態:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                
                console.log('[載入] 成功獲取檔案，開始解析...');
                
                const arrayBuffer = await response.arrayBuffer();
                console.log('[載入] 檔案大小:', (arrayBuffer.byteLength / 1024).toFixed(2), 'KB');
                
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                console.log('[載入] 成功解析，資料筆數:', jsonData.length);
                
                if (jsonData.length === 0) {
                    throw new Error('Excel檔案中沒有資料');
                }

                // 轉換資料格式
                auctionData = jsonData.map(row => {
                    // 計算投資氛圍
                    const atmosphere = calculateAtmosphere(row['投標倍數']);
                    
                    return {
                        no: row['序號'],
                        date: formatDate(row['開標日期']),
                        stockCode: String(row['股票代號']),
                        cbCode: String(row['CB代號']),
                        name: row['名稱'],
                        capital: parseFloat(row['股本']) || 0,
                        scale: parseFloat(row['發行規模']) || 0,
                        period: row['年期'] + '年',
                        secured: row['擔保'],
                        rating: parseInt(row['信評']) || 0,
                        volume: parseInt(row['競拍張數']) || 0,
                        floor: parseFloat(row['底標價']) || 0,
                        cutoffDate: formatDate(row['截標日']),
                        cutoffPrice: parseFloat(row['截標收盤']) || 0,
                        convPrice: parseFloat(row['轉換價']) || 0,
                        pricePremium: row['訂價溢價率'],
                        theoretical: parseFloat(row['理論價']) || 0,
                        minBid: parseFloat(row['最低得標']) || 0,
                        minPremium: (parseFloat(row['最低溢價']) || 0) * 100,
                        avgBid: parseFloat(row['平均得標']) || 0,
                        avgPremium: (parseFloat(row['平均溢價']) || 0) * 100,
                        listHigh: parseFloat(row['掛牌最高']) || 0,
                        listLow: parseFloat(row['掛牌最低']) || 0,
                        underwriter: row['發行券商'],
                        industry: row['產業分類'],
                        qualifiedCount: parseInt(row['合格件數']) || 0,
                        bidVolume: parseInt(row['投標張數']) || 0,
                        bidMultiple: parseFloat(row['投標倍數']) || 0,
                        avgBidVolume: parseFloat(row['投標均張']) || 0,
                        closePrice: parseFloat(row['CB最新收盤價']) || null,
                        atmosphere: atmosphere
                    };
                });

                console.log(`[載入] ✅ 成功載入 ${auctionData.length} 筆資料`);
                
                // 更新資料期間資訊
                updateDataPeriodInfo();
                
            } catch (error) {
                console.error('[錯誤] 載入資料失敗:', error);
                
                let errorHTML = '';
                
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    errorHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <h3 style="color: #d32f2f; margin-bottom: 20px;">❌ 找不到資料檔案</h3>
                            <div style="background: white; padding: 25px; border-radius: 10px; margin: 20px auto; max-width: 600px; text-align: left;">
                                <h4 style="color: #e65100; margin-bottom: 15px;">🔍 可能原因：</h4>
                                <ul style="line-height: 2; color: #424242;">
                                    <li><strong>auction_data.xlsx</strong> 檔案不存在</li>
                                    <li>檔案名稱不正確（注意大小寫）</li>
                                    <li>檔案不在與 HTML 相同的目錄</li>
                                </ul>
                                
                                <h4 style="color: #1976d2; margin: 20px 0 15px 0;">✅ 解決方式：</h4>
                                <ol style="line-height: 2; color: #424242;">
                                    <li>確認 <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">auction_data.xlsx</code> 與此HTML在同一個資料夾</li>
                                    <li>確認檔名完全正確（包含大小寫）</li>
                                    <li>重新整理頁面（按 Ctrl + F5 或 Cmd + Shift + R）</li>
                                    <li>如果使用本機開啟，建議使用本地伺服器</li>
                                </ol>
                                
                                <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #ff9800;">
                                    <strong style="color: #e65100;">💡 提示：</strong>
                                    <div style="color: #424242; margin-top: 8px;">
                                        如果使用 <code style="background: white; padding: 2px 6px; border-radius: 3px;">file://</code> 協定開啟，
                                        建議改用本地伺服器或上傳到網站空間。
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-right: 10px;">
                                    🔄 重新載入頁面
                                </button>
                                <button onclick="window.open('診斷工具.html', '_blank')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                                    🔧 開啟診斷工具
                                </button>
                            </div>
                        </div>
                    `;
                } else if (error.message.includes('沒有資料')) {
                    errorHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <h3 style="color: #d32f2f; margin-bottom: 20px;">❌ Excel檔案中沒有資料</h3>
                            <p style="color: #424242;">請確認 auction_data.xlsx 檔案中包含資料</p>
                            <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-top: 20px;">
                                🔄 重新載入頁面
                            </button>
                        </div>
                    `;
                } else {
                    errorHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <h3 style="color: #d32f2f; margin-bottom: 20px;">❌ 載入資料時發生錯誤</h3>
                            <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 600px; text-align: left;">
                                <p style="color: #424242;"><strong>錯誤訊息：</strong></p>
                                <code style="display: block; background: #f5f5f5; padding: 15px; border-radius: 5px; color: #c62828; margin: 10px 0;">${error.message}</code>
                                
                                <h4 style="color: #1976d2; margin: 20px 0 10px 0;">建議檢查：</h4>
                                <ul style="line-height: 2; color: #424242;">
                                    <li>使用 Chrome、Edge 或 Firefox 瀏覽器</li>
                                    <li>Excel 檔案是否正常（可以用 Excel 開啟）</li>
                                    <li>清除瀏覽器快取</li>
                                    <li>按 F12 打開開發者工具查看詳細錯誤</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-right: 10px;">
                                    🔄 重新載入頁面
                                </button>
                                <button onclick="window.open('診斷工具.html', '_blank')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                                    🔧 開啟診斷工具
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('dataUpdateBanner').innerHTML = errorHTML;
                document.getElementById('dataUpdateBanner').style.background = 'linear-gradient(135deg, #ffebee 0%, #ffffff 100%)';
                document.getElementById('dataUpdateBanner').style.color = '#c62828';
                document.getElementById('dataUpdateBanner').style.padding = '20px';
            }
        }

        // 日期格式化函數
        function formatDate(excelDate) {
            if (typeof excelDate === 'string') return excelDate;
            
            // Excel日期轉換
            const date = XLSX.SSF.parse_date_code(excelDate);
            return `${date.y}/${String(date.m).padStart(2, '0')}/${String(date.d).padStart(2, '0')}`;
        }

        // 計算投資氛圍
        function calculateAtmosphere(bidMultiple) {
            if (!bidMultiple || bidMultiple < 3) return '😊';
            if (bidMultiple <= 5) return '🔥';
            return '🚀';
        }

        // ==================== 基礎功能 ====================
        function displayCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', options);
        }

        function updateDataPeriodInfo() {
            if (auctionData.length === 0) {
                document.getElementById('dataUpdateBanner').innerHTML = '📅 資料載入中...';
                return;
            }

            // 取得最早和最晚的資料
            const sortedData = [...auctionData].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });

            const firstData = sortedData[0];
            const lastData = sortedData[sortedData.length - 1];
            
            // 格式化日期顯示
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return `${date.getFullYear()}年${date.getMonth() + 1}月`;
            };

            const startPeriod = formatDate(firstData.date);
            const endPeriod = formatDate(lastData.date);
            
            // 更新橫幅內容
            document.getElementById('dataUpdateBanner').innerHTML = `
                📅 競拍資料期間：${startPeriod}～${endPeriod}，共計 <strong>${auctionData.length}</strong> 檔 | 
                💰 CB最新收盤價：<strong>2025/10/27</strong>
            `;
            document.getElementById('dataUpdateBanner').style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffffff 100%)';
            document.getElementById('dataUpdateBanner').style.color = '#e65100';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'calculator') {
                checkCalculatorConditions();
            }
        }

        function updateInvestorType() {
            const selected = document.querySelector('input[name="investorType"]:checked');
            currentInvestorType = selected.value;
            localStorage.setItem('investorType', currentInvestorType);
        }

        function toggleCollapsible(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        }

        // ==================== 單檔查詢功能 ====================
        function executeSingleSearch() {
            if (auctionData.length === 0) {
                alert('資料尚未載入完成，請稍候再試');
                return;
            }

            const input = document.getElementById('singleSearchInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                alert('請輸入查詢關鍵字');
                return;
            }
            
            const results = auctionData.filter(item => 
                item.stockCode.includes(keyword) || 
                item.cbCode.includes(keyword) || 
                item.name.includes(keyword)
            );
            
            if (results.length === 0) {
                document.getElementById('singleResult').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #dc3545;">❌ 查無資料，請確認輸入內容</div>';
                return;
            }
            
            displaySingleResult(results, keyword);
        }

        function displaySingleResult(results, keyword) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;
            
            const companyName = results[0].name.replace(/[一二三四五六七八九十\d]/g, '');
            
            let html = `
                <div style="margin: 30px; overflow-x: auto;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin-bottom: 15px;">📊 ${companyName} 歷史競拍記錄</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9rem; color: #424242;">
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">股票代號</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${results[0].stockCode}</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">查詢關鍵字</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${keyword}</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">歷史記錄</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${results.length} 檔可轉債</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">平均投標倍數</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${avgBidMultiple.toFixed(2)}倍</strong>
                            </div>
                        </div>
                    </div>
                    
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>序號</th>
                                <th>開標日期</th>
                                <th>CB代號</th>
                                <th>名稱</th>
                                <th>產業</th>
                                <th>券商</th>
                                <th>規模</th>
                                <th>年期</th>
                                <th>擔保</th>
                                <th>信評</th>
                                <th>投標<br>倍數</th>
                                <th>最低<br>得標</th>
                                <th>最低<br>溢價</th>
                                <th>平均<br>得標</th>
                                <th>平均<br>溢價</th>
                                <th>掛牌<br>最高</th>
                                <th>掛牌<br>漲幅</th>
                                <th>最新<br>收盤</th>
                                <th>氛圍</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                let closePriceDisplay = '---';
                let priceDiffDisplay = '';
                if (item.closePrice) {
                    closePriceDisplay = item.closePrice.toFixed(2);
                    const diffMinBid = item.closePrice - item.minBid;
                    const diffPercent = (diffMinBid / item.minBid * 100).toFixed(1);
                    priceDiffDisplay = `<br><small style="color: ${diffMinBid >= 0 ? '#28a745' : '#dc3545'};">${diffMinBid >= 0 ? '+' : ''}${diffMinBid.toFixed(2)} (${diffPercent}%)</small>`;
                }
                
                html += `
                    <tr>
                        <td>${item.no}</td>
                        <td>${item.date}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}億</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === '有' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === '有' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#dc3545' : '#28a745'};">${gainRate.toFixed(1)}%</td>
                        <td>${closePriceDisplay}${priceDiffDisplay}</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });
            
            html += `
                        <tr class="highlight">
                            <td colspan="10" style="text-align: right; padding-right: 20px;">📊 歷史平均值</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #2196f3;">
                    <h4 style="color: #1976d2; margin-bottom: 20px; font-size: 1.1rem;">📈 ${companyName} 歷史趨勢分析</h4>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">發行次數</div>
                            <div class="value" style="color: #2196f3;">${results.length}次</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均投標倍數</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}倍</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低得標</div>
                            <div class="value">${avgMinBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標價</div>
                            <div class="value">${avgBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均溢價率</div>
                            <div class="value" style="color: ${avgPremium >= 0 ? '#dc3545' : '#28a745'};">${avgPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌最高</div>
                            <div class="value" style="color: #28a745;">${avgListHigh.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均蜜月漲幅</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: #fff9c4; border-radius: 6px; font-size: 0.85rem; color: #f57f17;">
                        <strong>📌 說明：</strong>最新收盤價若顯示「---」代表該檔可能已下市或尚未更新，僅供歷史資料參考
                    </div>
                </div>
            </div>
            `;
            
            document.getElementById('singleResult').innerHTML = html;
        }

        // ==================== 批次查詢功能 ====================
        
        // 時間區間查詢
        function queryByTimeRange(months) {
            if (auctionData.length === 0) {
                alert('資料尚未載入完成，請稍候再試');
                return;
            }

            // 計算時間範圍
            const now = new Date();
            const startDate = new Date(now);
            startDate.setMonth(startDate.getMonth() - months);

            // 篩選時間範圍內的資料
            const results = auctionData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate <= now;
            });

            if (results.length === 0) {
                alert(`最近${months}個月內無競拍資料`);
                return;
            }

            // 清空手動加入列表
            batchListItems = [];
            updateBatchList();

            // 顯示時間區間查詢結果
            displayTimeRangeResult(results, months);
        }

        function displayTimeRangeResult(results, months) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgListLow = results.reduce((sum, item) => sum + item.listLow, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;

            // 計算時間範圍
            const sortedResults = [...results].sort((a, b) => new Date(a.date) - new Date(b.date));
            const startDate = sortedResults[0].date;
            const endDate = sortedResults[sortedResults.length - 1].date;

            const aggressive = calculateAggressivePrice(results);

            let html = `
                <div style="margin: 30px; overflow-x: auto;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin-bottom: 15px;">📅 時間區間統計：最近 ${months} 個月</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9rem; color: #424242;">
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">查詢期間</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1rem;">${startDate} ~ ${endDate}</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">競拍檔數</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${results.length} 檔</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">平均投標倍數</span>
                                <strong style="display: block; margin-top: 4px; color: #2e7d32; font-size: 1.1rem;">${avgBidMultiple.toFixed(2)}倍</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">平均掛牌漲幅</span>
                                <strong style="display: block; margin-top: 4px; color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'}; font-size: 1.1rem;">${avgGainRate.toFixed(1)}%</strong>
                            </div>
                        </div>
                    </div>

                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>序</th>
                                <th>日期</th>
                                <th>代號</th>
                                <th>CB代號</th>
                                <th>名稱</th>
                                <th>產業</th>
                                <th>券商</th>
                                <th>規模</th>
                                <th>年期</th>
                                <th>擔保</th>
                                <th>信評</th>
                                <th>投標<br>倍數</th>
                                <th>最低<br>得標</th>
                                <th>最低<br>溢價</th>
                                <th>平均<br>得標</th>
                                <th>平均<br>溢價</th>
                                <th>掛牌<br>最高</th>
                                <th>掛牌<br>漲幅</th>
                                <th>氛圍</th>
                            </tr>
                        </thead>
                        <tbody>`;

            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.date}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.stockCode}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}億</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === '有' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === '有' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#dc3545' : '#28a745'};">${gainRate.toFixed(1)}%</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });

            html += `
                        <tr class="highlight">
                            <td colspan="11" style="text-align: right; padding-right: 20px;">📊 期間平均值</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 20px; font-size: 1.1rem;">💡 期間數據參考分析</h4>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem;">🎯 參考投標價格區間</h5>
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50;">
                                <strong style="color: #2e7d32;">參考價格A：</strong>
                                <span style="color: #424242;">${avgMinBid.toFixed(2)}元（溢價率 ${avgMinPremium.toFixed(2)}%），對應期間最低得標</span>
                            </div>
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                                <strong style="color: #1565c0;">參考價格B：</strong>
                                <span style="color: #424242;">${avgBid.toFixed(2)}元（溢價率 ${avgPremium.toFixed(2)}%），對應期間平均得標</span>
                            </div>
                            <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <strong style="color: #e65100;">參考價格C：</strong>
                                <span style="color: #424242;">${aggressive.price.toFixed(2)}元（溢價率 ${aggressive.premium.toFixed(2)}%）</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; font-size: 0.85rem; color: #616161;">
                        <strong>📌 說明：</strong>以上價格僅為期間數據統計參考，不構成投資建議。實際投標價格請依個人風險承受度評估。
                    </div>
                </div>

                <div class="info-card" style="margin-top: 30px;">
                    <h4>📊 期間綜合統計</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">期間檔數</div>
                            <div class="value" style="color: #2196f3;">${results.length}檔</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均投標倍數</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}倍</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低得標</div>
                            <div class="value">${avgMinBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低溢價率</div>
                            <div class="value" style="color: ${avgMinPremium >= 0 ? '#dc3545' : '#28a745'};">${avgMinPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標價</div>
                            <div class="value">${avgBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標溢價率</div>
                            <div class="value" style="color: ${avgPremium >= 0 ? '#dc3545' : '#28a745'};">${avgPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌最高</div>
                            <div class="value" style="color: #28a745;">${avgListHigh.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌最低</div>
                            <div class="value" style="color: #dc3545;">${avgListLow.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌漲幅</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            document.getElementById('batchResult').innerHTML = html;
            document.getElementById('batchChecklist').style.display = 'block';
        }
        
        function addToBatchList() {
            if (auctionData.length === 0) {
                alert('資料尚未載入完成，請稍候再試');
                return;
            }

            const input = document.getElementById('batchSearchInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                alert('請輸入查詢關鍵字');
                return;
            }
            
            if (batchListItems.length >= 20) {
                alert('最多只能查詢20檔');
                return;
            }
            
            if (batchListItems.includes(keyword)) {
                alert('此項目已在列表中');
                input.value = '';
                return;
            }
            
            batchListItems.push(keyword);
            input.value = '';
            input.focus();
            
            updateBatchList();
        }

        function updateBatchList() {
            const listDiv = document.getElementById('batchList');
            const buttonsDiv = document.getElementById('batchButtons');
            
            if (batchListItems.length === 0) {
                listDiv.innerHTML = '';
                buttonsDiv.style.display = 'none';
                return;
            }
            
            buttonsDiv.style.display = 'flex';
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #dee2e6;">';
            html += `<h4 style="color: #495057; margin-bottom: 15px;">📋 待比較列表（${batchListItems.length}/20）</h4>`;
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            
            batchListItems.forEach((item, index) => {
                html += `
                    <div style="background: white; padding: 10px 15px; border-radius: 20px; border: 2px solid #667eea; 
                                display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <span style="font-weight: 600; color: #667eea;">${item}</span>
                        <span onclick="removeFromBatchList(${index})" 
                              style="cursor: pointer; color: #dc3545; font-weight: bold; font-size: 1.2rem; 
                                     padding: 0 5px; border-radius: 50%; transition: all 0.3s;"
                              onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                              onmouseout="this.style.background=''; this.style.color='#dc3545';">×</span>
                    </div>
                `;
            });
            
            html += '</div></div>';
            listDiv.innerHTML = html;
        }

        function removeFromBatchList(index) {
            batchListItems.splice(index, 1);
            updateBatchList();
        }

        function clearBatchList() {
            batchListItems = [];
            updateBatchList();
            document.getElementById('batchResult').innerHTML = '';
            document.getElementById('batchChecklist').style.display = 'none';
            document.getElementById('batchSearchInput').focus();
        }

        function executeBatchSearch() {
            if (auctionData.length === 0) {
                alert('資料尚未載入完成，請稍候再試');
                return;
            }

            if (batchListItems.length === 0) {
                alert('請先加入查詢項目');
                return;
            }
            
            const results = [];
            const notFound = [];
            
            batchListItems.forEach(keyword => {
                const found = auctionData.find(item => 
                    item.stockCode.includes(keyword) || 
                    item.cbCode.includes(keyword) || 
                    item.name.includes(keyword)
                );
                if (found) {
                    results.push(found);
                } else {
                    notFound.push(keyword);
                }
            });

            if (results.length === 0) {
                document.getElementById('batchResult').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #dc3545;">❌ 查無任何資料，請檢查輸入內容</div>';
                return;
            }

            displayBatchResult(results, notFound);
        }

        function calculateAggressivePrice(results) {
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            
            let weightSum = 0;
            let weightDetails = [];
            
            results.forEach(item => {
                if (item.secured === '有') {
                    weightSum += 0.2;
                    if (!weightDetails.includes('有擔保')) weightDetails.push('有擔保 +0.2%');
                }
                if (item.period === '3年') {
                    weightSum += 0.3;
                    if (!weightDetails.includes('3年期')) weightDetails.push('3年期 +0.3%');
                }
                if (item.rating >= 3 && item.rating <= 5) {
                    weightSum += 0.5;
                    if (!weightDetails.includes('信評優良')) weightDetails.push('信評優良(3-5分) +0.5%');
                }
                if (item.scale >= 3 && item.scale <= 10) {
                    weightSum += 0.2;
                    if (!weightDetails.includes('規模適中')) weightDetails.push('規模適中(3-10億) +0.2%');
                }
                const itemGainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                if (itemGainRate > 25) {
                    weightSum += 0.5;
                    if (!weightDetails.includes('優異表現')) weightDetails.push('掛牌漲幅>25% +0.5%');
                } else if (itemGainRate > 15) {
                    weightSum += 0.3;
                    if (!weightDetails.includes('良好表現')) weightDetails.push('掛牌漲幅>15% +0.3%');
                }
                if (item.atmosphere === '😊') {
                    weightSum += 0.2;
                    if (!weightDetails.includes('溫和氛圍')) weightDetails.push('投資氛圍溫和 +0.2%');
                }
            });
            
            const avgWeight = weightSum / results.length;
            const aggressivePrice = avgBid * (1 + avgWeight / 100);
            const aggressivePremium = ((aggressivePrice - 100) / 100) * 100;
            
            return {
                price: aggressivePrice,
                premium: aggressivePremium,
                weight: avgWeight,
                details: weightDetails
            };
        }

        function displayBatchResult(results, notFound) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgListLow = results.reduce((sum, item) => sum + item.listLow, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;
            
            const aggressive = calculateAggressivePrice(results);

            let tableHTML = `
                <div style="margin: 30px; overflow-x: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">📋 批次比較結果：共 ${results.length} 檔</h3>
                    ${notFound.length > 0 ? `<p style="color: #dc3545; margin-bottom: 15px;">⚠️ 未找到：${notFound.join(', ')}</p>` : ''}
                    
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>序</th>
                                <th>代號</th>
                                <th>CB代號</th>
                                <th>名稱</th>
                                <th>產業</th>
                                <th>券商</th>
                                <th>規模</th>
                                <th>年期</th>
                                <th>擔保</th>
                                <th>信評</th>
                                <th>投標<br>倍數</th>
                                <th>最低<br>得標</th>
                                <th>最低<br>溢價</th>
                                <th>平均<br>得標</th>
                                <th>平均<br>溢價</th>
                                <th>掛牌<br>最高</th>
                                <th>掛牌<br>漲幅</th>
                                <th>氛圍</th>
                            </tr>
                        </thead>
                        <tbody>`;

            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.stockCode}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}億</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === '有' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === '有' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#dc3545' : '#28a745'};">${gainRate.toFixed(1)}%</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });

            tableHTML += `
                        <tr class="highlight">
                            <td colspan="10" style="text-align: right; padding-right: 20px;">📊 綜合平均值</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 20px; font-size: 1.1rem;">💡 歷史數據參考分析</h4>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem;">🎯 參考投標價格區間</h5>
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50;">
                                <strong style="color: #2e7d32;">參考價格A：</strong>
                                <span style="color: #424242;">${avgMinBid.toFixed(2)}元（溢價率 ${avgMinPremium.toFixed(2)}%），對應歷史最低得標</span>
                            </div>
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                                <strong style="color: #1565c0;">參考價格B：</strong>
                                <span style="color: #424242;">${avgBid.toFixed(2)}元（溢價率 ${avgPremium.toFixed(2)}%），對應歷史平均得標</span>
                            </div>
                            <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <strong style="color: #e65100;">參考價格C：</strong>
                                <span style="color: #424242;">${aggressive.price.toFixed(2)}元（溢價率 ${aggressive.premium.toFixed(2)}%）</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #f0f0f0; border-radius: 6px; font-size: 0.85rem;">
                            <strong>📈 平均投標倍數：</strong>${avgBidMultiple.toFixed(2)}倍
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; font-size: 0.85rem; color: #616161;">
                        <strong>📌 說明：</strong>以上價格僅為歷史數據統計參考，不構成投資建議。實際投標價格請依個人風險承受度評估。
                    </div>
                </div>

                <div class="info-card" style="margin-top: 30px;">
                    <h4>📊 綜合統計分析</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">比較檔數</div>
                            <div class="value" style="color: #2196f3;">${results.length}檔</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均投標倍數</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}倍</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低得標</div>
                            <div class="value">${avgMinBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低溢價率</div>
                            <div class="value" style="color: ${avgMinPremium >= 0 ? '#dc3545' : '#28a745'};">${avgMinPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標價</div>
                            <div class="value">${avgBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標溢價率</div>
                            <div class="value" style="color: ${avgPremium >= 0 ? '#dc3545' : '#28a745'};">${avgPremium.toFixed(2)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌最高</div>
                            <div class="value" style="color: #28a745;">${avgListHigh.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌最低</div>
                            <div class="value" style="color: #dc3545;">${avgListLow.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌漲幅</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            document.getElementById('batchResult').innerHTML = tableHTML;
            document.getElementById('batchChecklist').style.display = 'block';
        }

        // ==================== 條件篩選功能 ====================
        function executeFilterSearch() {
            if (auctionData.length === 0) {
                alert('資料尚未載入完成，請稍候再試');
                return;
            }

            const filterIndustry = document.getElementById('filterIndustry').value;
            const filterUnderwriter = document.getElementById('filterUnderwriter').value;
            const filterCapital = document.getElementById('filterCapital').value;
            const filterScale = document.getElementById('filterScale').value;
            const filterConvPrice = document.getElementById('filterConvPrice').value;
            const filterRating = document.getElementById('filterRating').value;
            const filterPeriod = document.getElementById('filterPeriod').value;
            const filterSecured = document.getElementById('filterSecured').value;

            const conditions = [filterIndustry, filterUnderwriter, filterCapital, filterScale, filterConvPrice, filterRating, filterPeriod, filterSecured];
            const selectedCount = conditions.filter(c => c !== '').length;

            if (selectedCount < 3) {
                alert('請至少選擇3個條件才能進行分析');
                return;
            }

            // 篩選資料
            const filteredData = auctionData.filter(item => {
                let match = true;

                // 產業分類
                if (filterIndustry && item.industry !== filterIndustry) match = false;

                // 發行券商
                if (filterUnderwriter && item.underwriter !== filterUnderwriter) match = false;

                // 股本區間
                if (filterCapital) {
                    if (filterCapital === '<3' && item.capital >= 3) match = false;
                    else if (filterCapital === '3-6' && (item.capital < 3 || item.capital >= 6)) match = false;
                    else if (filterCapital === '6-10' && (item.capital < 6 || item.capital >= 10)) match = false;
                    else if (filterCapital === '10-15' && (item.capital < 10 || item.capital >= 15)) match = false;
                    else if (filterCapital === '15-20' && (item.capital < 15 || item.capital >= 20)) match = false;
                    else if (filterCapital === '>20' && item.capital < 20) match = false;
                    else if (filterCapital === '<10' && item.capital >= 10) match = false;
                    else if (filterCapital === '>10' && item.capital < 10) match = false;
                }

                // 發行規模
                if (filterScale) {
                    if (filterScale === '<2' && item.scale >= 2) match = false;
                    else if (filterScale === '2-3' && (item.scale < 2 || item.scale >= 3)) match = false;
                    else if (filterScale === '3-6' && (item.scale < 3 || item.scale >= 6)) match = false;
                    else if (filterScale === '6-10' && (item.scale < 6 || item.scale >= 10)) match = false;
                    else if (filterScale === '10-15' && (item.scale < 10 || item.scale >= 15)) match = false;
                    else if (filterScale === '15-20' && (item.scale < 15 || item.scale >= 20)) match = false;
                    else if (filterScale === '>20' && item.scale < 20) match = false;
                    else if (filterScale === '<5' && item.scale >= 5) match = false;
                    else if (filterScale === '>5' && item.scale < 5) match = false;
                    else if (filterScale === '<10' && item.scale >= 10) match = false;
                    else if (filterScale === '>10' && item.scale < 10) match = false;
                }

                // 轉換價格
                if (filterConvPrice) {
                    if (filterConvPrice === '<20' && item.convPrice >= 20) match = false;
                    else if (filterConvPrice === '20-50' && (item.convPrice < 20 || item.convPrice >= 50)) match = false;
                    else if (filterConvPrice === '50-100' && (item.convPrice < 50 || item.convPrice >= 100)) match = false;
                    else if (filterConvPrice === '100-150' && (item.convPrice < 100 || item.convPrice >= 150)) match = false;
                    else if (filterConvPrice === '150-200' && (item.convPrice < 150 || item.convPrice >= 200)) match = false;
                    else if (filterConvPrice === '>200' && item.convPrice < 200) match = false;
                    else if (filterConvPrice === '<50' && item.convPrice >= 50) match = false;
                    else if (filterConvPrice === '>50' && item.convPrice < 50) match = false;
                    else if (filterConvPrice === '<100' && item.convPrice >= 100) match = false;
                    else if (filterConvPrice === '>100' && item.convPrice < 100) match = false;
                }

                // 信用評等
                if (filterRating) {
                    if (filterRating === '<=4' && item.rating > 4) match = false;
                    else if (filterRating === '>=5' && item.rating < 5) match = false;
                    else if (filterRating !== '<=4' && filterRating !== '>=5' && item.rating !== parseInt(filterRating)) match = false;
                }

                // 發行年期
                if (filterPeriod && item.period !== filterPeriod + '年') match = false;

                // 擔保情況
                if (filterSecured && item.secured !== filterSecured) match = false;

                return match;
            });

            if (filteredData.length === 0) {
                document.getElementById('filterResult').innerHTML = `
                    <div style="background: #ffebee; padding: 30px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #f44336; text-align: center;">
                        <h4 style="color: #c62828; margin-bottom: 10px;">❌ 查無符合條件的資料</h4>
                        <p style="color: #c62828;">請嘗試調整篩選條件</p>
                    </div>
                `;
                return;
            }

            // 儲存條件到 localStorage
            selectedFilterConditions = {
                industry: filterIndustry,
                underwriter: filterUnderwriter,
                capital: filterCapital,
                scale: filterScale,
                convPrice: filterConvPrice,
                rating: filterRating,
                period: filterPeriod,
                secured: filterSecured
            };
            localStorage.setItem('filterConditions', JSON.stringify(selectedFilterConditions));

            // 顯示篩選結果
            displayFilterResult(filteredData, selectedCount);
        }

        function displayFilterResult(results, conditionCount) {
            const avgMinBid = results.reduce((sum, item) => sum + item.minBid, 0) / results.length;
            const avgMinPremium = results.reduce((sum, item) => sum + item.minPremium, 0) / results.length;
            const avgBid = results.reduce((sum, item) => sum + item.avgBid, 0) / results.length;
            const avgPremium = results.reduce((sum, item) => sum + item.avgPremium, 0) / results.length;
            const avgListHigh = results.reduce((sum, item) => sum + item.listHigh, 0) / results.length;
            const avgListLow = results.reduce((sum, item) => sum + item.listLow, 0) / results.length;
            const avgGainRate = results.reduce((sum, item) => {
                return sum + ((item.listHigh - item.avgBid) / item.avgBid * 100);
            }, 0) / results.length;
            const avgBidMultiple = results.reduce((sum, item) => sum + item.bidMultiple, 0) / results.length;
            const avgCapital = results.reduce((sum, item) => sum + item.capital, 0) / results.length;
            const avgScale = results.reduce((sum, item) => sum + item.scale, 0) / results.length;
            const avgRating = results.reduce((sum, item) => sum + item.rating, 0) / results.length;
            const securedCount = results.filter(item => item.secured === '有').length;
            const securedRatio = (securedCount / results.length * 100);

            const aggressive = calculateAggressivePrice(results);

            // 計算排行榜
            const performanceList = results.map(item => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const priceRange = item.listHigh - item.listLow;
                const rangePercent = (priceRange / item.listLow * 100);
                return {
                    ...item,
                    gainRate: gainRate,
                    priceRange: priceRange,
                    rangePercent: rangePercent
                };
            });

            // 排序：表現最佳（漲幅最高）
            const topPerformers = [...performanceList].sort((a, b) => b.gainRate - a.gainRate).slice(0, 5);
            
            // 排序：表現最差（漲幅最低或跌幅最大）
            const worstPerformers = [...performanceList].sort((a, b) => a.gainRate - b.gainRate).slice(0, 5);

            let html = `
                <div style="margin: 30px; overflow-x: auto;">
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #2196f3;">
                        <h3 style="color: #1976d2; margin-bottom: 15px;">✅ 條件篩選結果</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9rem; color: #424242;">
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">已選條件數</span>
                                <strong style="display: block; margin-top: 4px; color: #1976d2; font-size: 1.1rem;">${conditionCount} 個條件</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">符合檔數</span>
                                <strong style="display: block; margin-top: 4px; color: #1976d2; font-size: 1.1rem;">${results.length} 檔</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">平均投標倍數</span>
                                <strong style="display: block; margin-top: 4px; color: #1976d2; font-size: 1.1rem;">${avgBidMultiple.toFixed(2)}倍</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <span style="color: #6c757d;">平均掛牌漲幅</span>
                                <strong style="display: block; margin-top: 4px; color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'}; font-size: 1.1rem;">${avgGainRate.toFixed(1)}%</strong>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #fff9c4; border-radius: 6px; font-size: 0.85rem; color: #f57f17;">
                            <strong>💡 提示：</strong>此條件已儲存，可前往「投標計算機」使用這些數據進行試算分析
                        </div>
                    </div>

                    <!-- 表現排行榜 -->
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #9c27b0;">
                        <h3 style="color: #7b1fa2; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>🏆</span><span>條件下表現排行榜</span>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
                            <!-- 表現最佳前5名 -->
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="color: #28a745; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                    <span>📈</span><span>表現最佳 TOP 5</span>
                                </h4>
                                ${generatePerformersList(topPerformers, true)}
                            </div>
                            
                            <!-- 表現最差後5名 -->
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                    <span>📉</span><span>表現最差 LAST 5</span>
                                </h4>
                                ${generatePerformersList(worstPerformers, false)}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 6px; font-size: 0.85rem; color: #e65100;">
                            <strong>📌 說明：</strong>排名依據「掛牌最高價表現」計算，顯示從平均得標到掛牌最高的漲跌幅度
                        </div>
                    </div>

                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>序</th>
                                <th>日期</th>
                                <th>代號</th>
                                <th>CB代號</th>
                                <th>名稱</th>
                                <th>產業</th>
                                <th>券商</th>
                                <th>規模</th>
                                <th>年期</th>
                                <th>擔保</th>
                                <th>信評</th>
                                <th>投標<br>倍數</th>
                                <th>最低<br>得標</th>
                                <th>最低<br>溢價</th>
                                <th>平均<br>得標</th>
                                <th>平均<br>溢價</th>
                                <th>掛牌<br>最高</th>
                                <th>掛牌<br>漲幅</th>
                                <th>氛圍</th>
                            </tr>
                        </thead>
                        <tbody>`;

            results.forEach((item, index) => {
                const gainRate = ((item.listHigh - item.avgBid) / item.avgBid * 100);
                const minPremiumClass = item.minPremium >= 0 ? 'positive' : 'negative';
                const avgPremiumClass = item.avgPremium >= 0 ? 'positive' : 'negative';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.date}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.stockCode}</td>
                        <td style="font-weight: 600; color: #667eea;">${item.cbCode}</td>
                        <td style="text-align: left; white-space: nowrap;">${item.name}</td>
                        <td style="font-size: 0.75rem;">${item.industry || '-'}</td>
                        <td style="font-size: 0.75rem;">${item.underwriter || '-'}</td>
                        <td>${item.scale}億</td>
                        <td>${item.period}</td>
                        <td><span style="padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; background: ${item.secured === '有' ? '#d4edda' : '#f8d7da'}; color: ${item.secured === '有' ? '#155724' : '#721c24'};">${item.secured}</span></td>
                        <td>${item.rating}</td>
                        <td style="font-weight: 600;">${item.bidMultiple.toFixed(2)}</td>
                        <td style="font-weight: 600;">${item.minBid.toFixed(2)}</td>
                        <td class="${minPremiumClass}">${item.minPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600;">${item.avgBid.toFixed(2)}</td>
                        <td class="${avgPremiumClass}">${item.avgPremium.toFixed(1)}%</td>
                        <td style="font-weight: 600; color: #28a745;">${item.listHigh.toFixed(2)}</td>
                        <td style="font-weight: 600; color: ${gainRate >= 0 ? '#dc3545' : '#28a745'};">${gainRate.toFixed(1)}%</td>
                        <td style="font-size: 1.2rem;">${item.atmosphere}</td>
                    </tr>`;
            });

            html += `
                        <tr class="highlight">
                            <td colspan="11" style="text-align: right; padding-right: 20px;">📊 條件平均值</td>
                            <td style="font-weight: 600;">${avgBidMultiple.toFixed(2)}</td>
                            <td>${avgMinBid.toFixed(2)}</td>
                            <td class="${avgMinPremium >= 0 ? 'positive' : 'negative'}">${avgMinPremium.toFixed(2)}%</td>
                            <td>${avgBid.toFixed(2)}</td>
                            <td class="${avgPremium >= 0 ? 'positive' : 'negative'}">${avgPremium.toFixed(2)}%</td>
                            <td style="color: #28a745;">${avgListHigh.toFixed(2)}</td>
                            <td style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(1)}%</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 20px; font-size: 1.1rem;">💡 條件數據參考分析</h4>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 1rem;">🎯 參考投標價格區間</h5>
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50;">
                                <strong style="color: #2e7d32;">參考價格A：</strong>
                                <span style="color: #424242;">${avgMinBid.toFixed(2)}元（溢價率 ${avgMinPremium.toFixed(2)}%），對應條件最低得標</span>
                            </div>
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                                <strong style="color: #1565c0;">參考價格B：</strong>
                                <span style="color: #424242;">${avgBid.toFixed(2)}元（溢價率 ${avgPremium.toFixed(2)}%），對應條件平均得標</span>
                            </div>
                            <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <strong style="color: #e65100;">參考價格C：</strong>
                                <span style="color: #424242;">${aggressive.price.toFixed(2)}元（溢價率 ${aggressive.premium.toFixed(2)}%）</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; font-size: 0.85rem; color: #616161;">
                        <strong>📌 說明：</strong>以上價格僅為符合條件的歷史數據統計參考，不構成投資建議。實際投標價格請依個人風險承受度評估。
                    </div>
                </div>

                <div class="info-card" style="margin-top: 30px;">
                    <h4>📊 條件綜合統計</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">符合檔數</div>
                            <div class="value" style="color: #2196f3;">${results.length}檔</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均股本</div>
                            <div class="value">${avgCapital.toFixed(2)}億</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均規模</div>
                            <div class="value">${avgScale.toFixed(2)}億</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均信評</div>
                            <div class="value">${avgRating.toFixed(2)}分</div>
                        </div>
                        <div class="info-item">
                            <div class="label">有擔保比例</div>
                            <div class="value">${securedRatio.toFixed(1)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均投標倍數</div>
                            <div class="value">${avgBidMultiple.toFixed(2)}倍</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均最低得標</div>
                            <div class="value">${avgMinBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均得標價</div>
                            <div class="value">${avgBid.toFixed(2)}元</div>
                        </div>
                        <div class="info-item">
                            <div class="label">平均掛牌漲幅</div>
                            <div class="value" style="color: ${avgGainRate >= 0 ? '#dc3545' : '#28a745'};">${avgGainRate.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            document.getElementById('filterResult').innerHTML = html;
        }

        // 生成表現者列表的HTML
        function generatePerformersList(performers, isTop) {
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            performers.forEach((item, index) => {
                const rankColor = isTop ? '#28a745' : '#dc3545';
                const bgColor = isTop ? '#e8f5e9' : '#ffebee';
                
                html += `
                    <div style="padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 3px solid ${rankColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem; font-weight: 700; color: ${rankColor};">#${index + 1}</span>
                                <span style="font-weight: 600; color: #495057;">${item.name}</span>
                                <span style="font-size: 0.75rem; color: #6c757d;">(${item.cbCode})</span>
                            </div>
                            <span style="font-size: 1.1rem; font-weight: 700; color: ${item.gainRate >= 0 ? '#dc3545' : '#28a745'};">
                                ${item.gainRate >= 0 ? '+' : ''}${item.gainRate.toFixed(1)}%
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.8rem;">
                            <div>
                                <span style="color: #6c757d;">平均得標：</span>
                                <strong>${item.avgBid.toFixed(2)}</strong>
                            </div>
                            <div>
                                <span style="color: #6c757d;">掛牌最高：</span>
                                <strong style="color: #28a745;">${item.listHigh.toFixed(2)}</strong>
                            </div>
                            <div>
                                <span style="color: #6c757d;">掛牌最低：</span>
                                <strong style="color: #dc3545;">${item.listLow.toFixed(2)}</strong>
                            </div>
                        </div>
                        <div style="margin-top: 6px; font-size: 0.8rem; color: #6c757d;">
                            <span>價格區間：</span>
                            <strong>${item.priceRange.toFixed(2)}元</strong>
                            <span style="margin-left: 10px;">波動幅度：</span>
                            <strong>${item.rangePercent.toFixed(1)}%</strong>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function resetFilters() {
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterUnderwriter').value = '';
            document.getElementById('filterCapital').value = '';
            document.getElementById('filterScale').value = '';
            document.getElementById('filterConvPrice').value = '';
            document.getElementById('filterRating').value = '';
            document.getElementById('filterPeriod').value = '';
            document.getElementById('filterSecured').value = '';
            document.getElementById('filterResult').innerHTML = '';
            selectedFilterConditions = {};
            localStorage.removeItem('filterConditions');
        }

        // ==================== 投標計算機功能 ====================
        function checkCalculatorConditions() {
            const savedConditions = localStorage.getItem('filterConditions');
            const checkDiv = document.getElementById('calculatorCheckConditions');
            const mainDiv = document.getElementById('calculatorMain');

            if (!savedConditions) {
                checkDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 30px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107; text-align: center;">
                        <h4 style="color: #856404; margin-bottom: 15px;">⚠️ 請先設定篩選條件</h4>
                        <p style="color: #856404; margin-bottom: 20px;">投標計算機需要先在「條件篩選」中選擇至少3個條件</p>
                        <button class="btn btn-primary" onclick="document.querySelectorAll('.tab')[2].click()">前往條件篩選</button>
                    </div>
                `;
                mainDiv.style.display = 'none';
                return;
            }

            const conditions = JSON.parse(savedConditions);
            const conditionCount = Object.values(conditions).filter(v => v !== '').length;

            if (conditionCount < 3) {
                checkDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 30px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107; text-align: center;">
                        <h4 style="color: #856404; margin-bottom: 15px;">⚠️ 條件數量不足</h4>
                        <p style="color: #856404; margin-bottom: 20px;">目前已選擇 ${conditionCount} 個條件，需要至少3個條件才能使用投標計算機</p>
                        <button class="btn btn-primary" onclick="document.querySelectorAll('.tab')[2].click()">前往補充條件</button>
                    </div>
                `;
                mainDiv.style.display = 'none';
                return;
            }

            selectedFilterConditions = conditions;
            checkDiv.innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">✅ 條件檢查通過</h4>
                    <p style="color: #155724; margin: 0;">已選擇 <strong>${conditionCount}</strong> 個條件，可以開始使用投標計算機</p>
                </div>
            `;
            mainDiv.style.display = 'block';

            document.getElementById('calcConvPrice').addEventListener('input', calculateTheoretical);
            document.getElementById('calcStockPrice').addEventListener('input', calculateTheoretical);
        }

        function calculateTheoretical() {
            const convPrice = parseFloat(document.getElementById('calcConvPrice').value);
            const stockPrice = parseFloat(document.getElementById('calcStockPrice').value);

            if (convPrice && stockPrice && convPrice > 0) {
                const theoretical = (stockPrice / convPrice) * 100;
                document.getElementById('calcTheoretical').value = theoretical.toFixed(2) + ' 元';
            } else {
                document.getElementById('calcTheoretical').value = '';
            }
        }

        // 生成批次投標建議
        function generateBatchBidSuggestions(data) {
            const minBid = data.historicalAvgMinBid;
            const avgBid = data.historicalAvgBid;
            const maxBid = data.historicalAvgMaxBid;
            
            // 策略A：保守穩健（3個價格）
            const conservativePrice1 = minBid - 0.5; // 略低於歷史最低
            const conservativePrice2 = minBid; // 歷史最低
            const conservativePrice3 = (minBid + avgBid) / 2; // 最低與平均之間
            
            // 策略B：平衡配置（5個價格）
            const balancedPrice1 = minBid - 1.0;
            const balancedPrice2 = minBid;
            const balancedPrice3 = avgBid;
            const balancedPrice4 = (avgBid + maxBid) / 2;
            const balancedPrice5 = maxBid;
            
            // 策略C：積極進取（5個價格，較高價位）
            const aggressivePrice1 = avgBid - 1.0;
            const aggressivePrice2 = avgBid;
            const aggressivePrice3 = avgBid + 1.0;
            const aggressivePrice4 = maxBid;
            const aggressivePrice5 = maxBid + 1.0;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 15px;">
                    <!-- 策略A：保守穩健 -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #4caf50;">
                        <h5 style="color: #2e7d32; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <span>🛡️</span><span>策略A：保守穩健</span>
                        </h5>
                        <div style="background: #f1f8e9; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="font-size: 0.85rem; color: #33691e; line-height: 1.6;">
                                <strong>適合對象：</strong>首次投標、風險承受度低<br>
                                <strong>策略說明：</strong>集中在歷史最低價附近<br>
                                <strong>得標機率：</strong>⭐⭐⭐⭐ 高<br>
                                <strong>處理費用：</strong>1,200元（3筆標單）
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格1</span>
                                <span style="font-weight: 700; color: #2e7d32; font-size: 1.1rem;">${conservativePrice1.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格2</span>
                                <span style="font-weight: 700; color: #2e7d32; font-size: 1.1rem;">${conservativePrice2.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格3</span>
                                <span style="font-weight: 700; color: #2e7d32; font-size: 1.1rem;">${conservativePrice3.toFixed(2)}元</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 4px; font-size: 0.8rem; color: #1b5e20;">
                            <strong>優點：</strong>得標機會高、風險較低<br>
                            <strong>缺點：</strong>可能全部得標、資金壓力大
                        </div>
                    </div>

                    <!-- 策略B：平衡配置 -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #2196f3;">
                        <h5 style="color: #1565c0; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <span>⚖️</span><span>策略B：平衡配置</span>
                        </h5>
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="font-size: 0.85rem; color: #0d47a1; line-height: 1.6;">
                                <strong>適合對象：</strong>有經驗、追求平衡<br>
                                <strong>策略說明：</strong>廣範圍分布，涵蓋各價位<br>
                                <strong>得標機率：</strong>⭐⭐⭐ 中高<br>
                                <strong>處理費用：</strong>2,000元（5筆標單）
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格1</span>
                                <span style="font-weight: 700; color: #1565c0; font-size: 1.1rem;">${balancedPrice1.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格2</span>
                                <span style="font-weight: 700; color: #1565c0; font-size: 1.1rem;">${balancedPrice2.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格3</span>
                                <span style="font-weight: 700; color: #1565c0; font-size: 1.1rem;">${balancedPrice3.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格4</span>
                                <span style="font-weight: 700; color: #1565c0; font-size: 1.1rem;">${balancedPrice4.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格5</span>
                                <span style="font-weight: 700; color: #1565c0; font-size: 1.1rem;">${balancedPrice5.toFixed(2)}元</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 0.8rem; color: #0d47a1;">
                            <strong>優點：</strong>平衡風險與機會、分散得標<br>
                            <strong>缺點：</strong>處理費較高（2,000元）
                        </div>
                    </div>

                    <!-- 策略C：積極進取 -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #ff9800;">
                        <h5 style="color: #e65100; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <span>🚀</span><span>策略C：積極進取</span>
                        </h5>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="font-size: 0.85rem; color: #e65100; line-height: 1.6;">
                                <strong>適合對象：</strong>追求確定性、資金充裕<br>
                                <strong>策略說明：</strong>集中在平均以上價位<br>
                                <strong>得標機率：</strong>⭐⭐⭐⭐⭐ 極高<br>
                                <strong>處理費用：</strong>2,000元（5筆標單）
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格1</span>
                                <span style="font-weight: 700; color: #e65100; font-size: 1.1rem;">${aggressivePrice1.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格2</span>
                                <span style="font-weight: 700; color: #e65100; font-size: 1.1rem;">${aggressivePrice2.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格3</span>
                                <span style="font-weight: 700; color: #e65100; font-size: 1.1rem;">${aggressivePrice3.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格4</span>
                                <span style="font-weight: 700; color: #e65100; font-size: 1.1rem;">${aggressivePrice4.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d; font-size: 0.85rem;">價格5</span>
                                <span style="font-weight: 700; color: #e65100; font-size: 1.1rem;">${aggressivePrice5.toFixed(2)}元</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #fff3e0; border-radius: 4px; font-size: 0.8rem; color: #e65100;">
                            <strong>優點：</strong>得標確定性高、競爭優勢大<br>
                            <strong>缺點：</strong>成本較高、利潤空間較小
                        </div>
                    </div>
                </div>
            `;
        }


        function analyzePrice() {
            const convPrice = parseFloat(document.getElementById('calcConvPrice').value);
            const stockPrice = parseFloat(document.getElementById('calcStockPrice').value);
            const bidPrice = parseFloat(document.getElementById('calcBidPrice').value);

            if (!convPrice || !stockPrice || !bidPrice) {
                alert('請完整填寫所有欄位');
                return;
            }

            if (convPrice <= 0 || stockPrice <= 0 || bidPrice <= 0) {
                alert('價格必須大於0');
                return;
            }

            const theoretical = (stockPrice / convPrice) * 100;
            const premium = ((bidPrice - 100) / 100) * 100;

            // 這裡應該根據條件篩選歷史資料，暫時用假數據
            const historicalAvgMinBid = 108.50;
            const historicalAvgBid = 110.80;
            const historicalAvgMaxBid = 115.20;
            const historicalAvgListHigh = 135.60;
            const historicalCount = 15;

            const diffMinBid = bidPrice - historicalAvgMinBid;
            const diffAvgBid = bidPrice - historicalAvgBid;
            const diffMaxBid = bidPrice - historicalAvgMaxBid;
            const maxCost = bidPrice - 100;
            const costRate = (maxCost / bidPrice) * 100;
            const potentialProfit = historicalAvgListHigh - bidPrice;
            const profitRate = (potentialProfit / bidPrice) * 100;

            currentAnalysisData = {
                convPrice, stockPrice, bidPrice, theoretical, premium,
                historicalAvgMinBid, historicalAvgBid, historicalAvgMaxBid, historicalAvgListHigh,
                historicalCount, diffMinBid, diffAvgBid, diffMaxBid, maxCost, costRate,
                potentialProfit, profitRate, conditions: selectedFilterConditions
            };

            displayAnalysisResult();
        }

        function generatePriceDistribution(data) {
            // 建立價格陣列並排序(由高到低)
            const prices = [
                { value: data.historicalAvgMaxBid, label: '歷史平均最高得標', isUserPrice: false },
                { value: data.bidPrice, label: '您的投標價', isUserPrice: true },
                { value: data.historicalAvgBid, label: '歷史平均得標價', isUserPrice: false },
                { value: data.historicalAvgMinBid, label: '歷史平均最低得標', isUserPrice: false },
                { value: 100, label: '底標基準', isUserPrice: false }
            ];
            
            // 由高到低排序
            prices.sort((a, b) => b.value - a.value);
            
            // 生成HTML
            let html = '';
            prices.forEach(price => {
                if (price.isUserPrice) {
                    html += `<div class="your-price-line">${price.value.toFixed(2)}元 ●━━ ${price.label}</div>`;
                } else {
                    html += `<div class="price-line">${price.value.toFixed(2)}元 ━━━ ${price.label}</div>`;
                }
            });
            
            return html;
        }

        function displayAnalysisResult() {
            const data = currentAnalysisData;

            // 計算批次投標建議
            const batchSuggestions = generateBatchBidSuggestions(data);

            let html = `
                <div class="result-box" style="margin-top: 30px;">
                    <!-- 批次投標建議 -->
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>📝</span><span>批次投標建議（多價格策略）</span>
                        </h3>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #1976d2; margin-bottom: 15px; font-size: 1rem;">💡 為什麼要寫多個價格？</h4>
                            <div style="color: #424242; font-size: 0.9rem; line-height: 1.8;">
                                <p style="margin-bottom: 8px;">✅ <strong>提高得標機會：</strong>不同價格區間可能都有得標機會</p>
                                <p style="margin-bottom: 8px;">✅ <strong>分散風險：</strong>避免全部得標在同一個價格</p>
                                <p style="margin-bottom: 8px;">✅ <strong>靈活配置：</strong>可以根據資金狀況分配張數</p>
                                <p style="margin-bottom: 0;">⚠️ <strong>注意成本：</strong>每個價格需支付400元處理費</p>
                            </div>
                        </div>

                        ${batchSuggestions}
                        
                        <div style="background: #fff9c4; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid #fbc02d;">
                            <strong style="color: #f57f17;">💰 成本提醒：</strong>
                            <div style="font-size: 0.9rem; color: #424242; margin-top: 8px;">
                                • 寫3個價格 = 3筆標單 = 1,200元處理費<br>
                                • 寫5個價格 = 5筆標單 = 2,000元處理費<br>
                                • 建議考慮處理費後再決定價格數量
                            </div>
                        </div>
                    </div>

                    <h3 style="color: #1976d2; margin-bottom: 20px;">📊 歷史數據對比分析</h3>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">您輸入的價格</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">投標價格</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #667eea;">${data.bidPrice.toFixed(2)}元</div>
                            </div>
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">溢價率</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: ${data.premium >= 0 ? '#dc3545' : '#28a745'};">${data.premium.toFixed(2)}%</div>
                            </div>
                            <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="color: #6c757d; font-size: 0.85rem;">理論價值</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #495057;">${data.theoretical.toFixed(2)}元</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">符合條件的歷史標的（共${data.historicalCount}檔）統計</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">平均最低得標</span>
                                <span style="font-weight: 600;">${data.historicalAvgMinBid.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">平均得標價</span>
                                <span style="font-weight: 600;">${data.historicalAvgBid.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">平均最高得標</span>
                                <span style="font-weight: 600;">${data.historicalAvgMaxBid.toFixed(2)}元</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">價差統計</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs 平均最低</span>
                                <span style="font-weight: 600; color: ${data.diffMinBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffMinBid >= 0 ? '+' : ''}${data.diffMinBid.toFixed(2)}元 (${((data.diffMinBid/data.historicalAvgMinBid)*100).toFixed(1)}%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs 平均價</span>
                                <span style="font-weight: 600; color: ${data.diffAvgBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffAvgBid >= 0 ? '+' : ''}${data.diffAvgBid.toFixed(2)}元 (${((data.diffAvgBid/data.historicalAvgBid)*100).toFixed(1)}%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">vs 平均最高</span>
                                <span style="font-weight: 600; color: ${data.diffMaxBid >= 0 ? '#dc3545' : '#28a745'};">${data.diffMaxBid >= 0 ? '+' : ''}${data.diffMaxBid.toFixed(2)}元 (${((data.diffMaxBid/data.historicalAvgMaxBid)*100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">價格分布參考</h4>
                        <div class="price-chart">
                            ${generatePriceDistribution(data)}
                        </div>
                        <p style="text-align: center; color: #6c757d; font-size: 0.85rem; margin-top: 10px;">說明：價格由高至低排列，標示您的投標價位置</p>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">💰 成本風險試算</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">投標價格</span>
                                <span style="font-weight: 600;">${data.bidPrice.toFixed(2)}元</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                <span style="color: #856404;">最大成本</span>
                                <span style="font-weight: 600; color: #dc3545;">${data.maxCost.toFixed(2)}元（投標價-100元）</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <span style="color: #6c757d;">成本率</span>
                                <span style="font-weight: 600; color: #dc3545;">${data.costRate.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 15px;">📈 機會評估</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #d4edda; border-radius: 4px;">
                                <span style="color: #155724;">若達歷史平均掛牌最高（${data.historicalAvgListHigh.toFixed(2)}元）</span>
                                <span style="font-weight: 600; color: #28a745;">+${data.potentialProfit.toFixed(2)}元 (+${data.profitRate.toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportReport('txt')">📄 匯出純文字</button>
                        <button class="btn btn-primary" onclick="exportReport('html')">📋 匯出HTML</button>
                        <button class="btn btn-primary" onclick="exportReport('pdf')">📥 匯出PDF</button>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 0.9rem; color: #856404;">
                        <strong>💡 說明：</strong>所有數據僅供參考，不構成投資建議。投資決策請自行評估風險。
                    </div>
                </div>
            `;

            document.getElementById('calculatorResult').innerHTML = html;
        }

        function exportReport(format) {
            if (!currentAnalysisData) {
                alert('請先進行價格分析');
                return;
            }

            switch(format) {
                case 'txt':
                    exportTextReport();
                    break;
                case 'html':
                    alert('HTML報告匯出功能開發中');
                    break;
                case 'pdf':
                    alert('PDF報告匯出功能開發中');
                    break;
            }
        }

        function exportTextReport() {
            const data = currentAnalysisData;
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW');
            const timeStr = now.toLocaleTimeString('zh-TW');

            const report = `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        可轉債投標試算分析報告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

報告產生時間：${dateStr} ${timeStr}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
一、基本資料
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

轉換價格：${data.convPrice.toFixed(2)}元
股票市價：${data.stockPrice.toFixed(2)}元
理論價值：${data.theoretical.toFixed(2)}元

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
二、投標價格分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

您的投標價格：${data.bidPrice.toFixed(2)}元（溢價率 ${data.premium.toFixed(2)}%）

歷史數據對比：
vs 平均最低得標：${data.diffMinBid >= 0 ? '+' : ''}${data.diffMinBid.toFixed(2)}元
vs 平均得標價：${data.diffAvgBid >= 0 ? '+' : ''}${data.diffAvgBid.toFixed(2)}元
vs 平均最高得標：${data.diffMaxBid >= 0 ? '+' : ''}${data.diffMaxBid.toFixed(2)}元

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
三、風險評估
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

最大成本：${data.maxCost.toFixed(2)}元
成本率：${data.costRate.toFixed(2)}%
潛在獲利：+${data.potentialProfit.toFixed(2)}元 (+${data.profitRate.toFixed(1)}%)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 免責聲明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

本報告僅提供歷史數據統計與試算參考
所有數據不構成任何投資建議
投資決策請自行評估風險

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
資料來源：Rex大叔的168台股投資教室
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `可轉債投標試算報告_${dateStr.replace(/\//g, '')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 初始化
        window.onload = function() {
            displayCurrentDate();
            
            // 自動載入 Excel 資料
            loadExcelData();
            
            const saved = localStorage.getItem('investorType');
            if (saved) {
                currentInvestorType = saved;
                const radio = document.querySelector(`input[name="investorType"][value="${saved}"]`);
                if (radio) radio.checked = true;
            }

            const savedConditions = localStorage.getItem('filterConditions');
            if (savedConditions) {
                selectedFilterConditions = JSON.parse(savedConditions);
            }
        };
    </script>
</body>
</html>