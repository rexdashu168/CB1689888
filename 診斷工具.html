<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯è½‰å‚µç³»çµ±è¨ºæ–·å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .loading {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #1976d2;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .info {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #e65100;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
        }
        .log-item.success { color: #2e7d32; }
        .log-item.error { color: #c62828; }
        .log-item.info { color: #1976d2; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-group {
            text-align: center;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background: #f5f5f5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¯è½‰å‚µç³»çµ±è¨ºæ–·å·¥å…·</h1>
        
        <div class="btn-group">
            <button onclick="startDiagnosis()">ğŸ” é–‹å§‹è¨ºæ–·</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
            <button onclick="testExcelLoad()">ğŸ“Š æ¸¬è©¦è¼‰å…¥Excel</button>
        </div>
        
        <div id="status"></div>
        <div id="log" class="log"></div>
        <div id="dataPreview"></div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        const previewDiv = document.getElementById('dataPreview');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logDiv.innerHTML = '';
            statusDiv.innerHTML = '';
            previewDiv.innerHTML = '';
        }

        function showStatus(message, type) {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function startDiagnosis() {
            clearLog();
            log('========== é–‹å§‹ç³»çµ±è¨ºæ–· ==========', 'info');
            
            // 1. æª¢æŸ¥ç€è¦½å™¨
            log('1ï¸âƒ£ æª¢æŸ¥ç€è¦½å™¨...', 'info');
            const ua = navigator.userAgent;
            log(`ç€è¦½å™¨: ${navigator.appName}`, 'info');
            log(`ç‰ˆæœ¬: ${navigator.appVersion}`, 'info');
            log(`User Agent: ${ua}`, 'info');
            
            // 2. æª¢æŸ¥XLSXå‡½å¼åº«
            log('2ï¸âƒ£ æª¢æŸ¥XLSXå‡½å¼åº«...', 'info');
            if (typeof XLSX !== 'undefined') {
                log('âœ… XLSXå‡½å¼åº«å·²è¼‰å…¥', 'success');
                log(`ç‰ˆæœ¬: ${XLSX.version}`, 'info');
            } else {
                log('âŒ XLSXå‡½å¼åº«æœªè¼‰å…¥ï¼', 'error');
                showStatus('âŒ XLSXå‡½å¼åº«æœªè¼‰å…¥ï¼Œç„¡æ³•è®€å–Excelæª”æ¡ˆ', 'error');
                return;
            }
            
            // 3. æª¢æŸ¥ç•¶å‰è·¯å¾‘
            log('3ï¸âƒ£ æª¢æŸ¥ç•¶å‰è·¯å¾‘...', 'info');
            log(`ç•¶å‰ç¶²å€: ${window.location.href}`, 'info');
            log(`å”å®š: ${window.location.protocol}`, 'info');
            
            if (window.location.protocol === 'file:') {
                log('âš ï¸ ä½¿ç”¨file://å”å®šï¼Œå¯èƒ½æœƒæœ‰CORSå•é¡Œ', 'error');
                showStatus('âš ï¸ å»ºè­°ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨æˆ–ä¸Šå‚³åˆ°ç¶²ç«™', 'info');
            }
            
            // 4. æ¸¬è©¦è¼‰å…¥Excel
            await testExcelLoad();
            
            log('========== è¨ºæ–·å®Œæˆ ==========', 'info');
        }

        async function testExcelLoad() {
            log('4ï¸âƒ£ å˜—è©¦è¼‰å…¥ auction_data.xlsx...', 'info');
            showStatus('ğŸ“Š æ­£åœ¨è¼‰å…¥ auction_data.xlsx...', 'loading');
            
            try {
                // å˜—è©¦è¼‰å…¥æª”æ¡ˆ
                log('ç™¼é€è«‹æ±‚åˆ°: auction_data.xlsx', 'info');
                const response = await fetch('auction_data.xlsx');
                
                log(`HTTPç‹€æ…‹ç¢¼: ${response.status}`, 'info');
                log(`ç‹€æ…‹æ–‡å­—: ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                log('âœ… æˆåŠŸç²å–æª”æ¡ˆ', 'success');
                
                // è®€å–æª”æ¡ˆ
                log('æ­£åœ¨è®€å–æª”æ¡ˆå…§å®¹...', 'info');
                const arrayBuffer = await response.arrayBuffer();
                log(`æª”æ¡ˆå¤§å°: ${(arrayBuffer.byteLength / 1024).toFixed(2)} KB`, 'info');
                
                // è§£æExcel
                log('æ­£åœ¨è§£æExcel...', 'info');
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                log(`å·¥ä½œè¡¨æ•¸é‡: ${workbook.SheetNames.length}`, 'info');
                log(`å·¥ä½œè¡¨åç¨±: ${workbook.SheetNames.join(', ')}`, 'info');
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                log(`è®€å–å·¥ä½œè¡¨: ${firstSheetName}`, 'info');
                
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                log(`âœ… æˆåŠŸè§£æï¼Œå…± ${jsonData.length} ç­†è³‡æ–™`, 'success');
                
                if (jsonData.length === 0) {
                    log('âŒ è­¦å‘Šï¼šè³‡æ–™ç‚ºç©ºï¼', 'error');
                    showStatus('âŒ Excelæª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™', 'error');
                    return;
                }
                
                // æª¢æŸ¥æ¬„ä½
                log('5ï¸âƒ£ æª¢æŸ¥æ¬„ä½...', 'info');
                const requiredColumns = [
                    'åºè™Ÿ', 'é–‹æ¨™æ—¥æœŸ', 'è‚¡ç¥¨ä»£è™Ÿ', 'CBä»£è™Ÿ', 'åç¨±', 
                    'è‚¡æœ¬', 'ç™¼è¡Œè¦æ¨¡', 'å¹´æœŸ', 'æ“”ä¿', 'ä¿¡è©•',
                    'ç«¶æ‹å¼µæ•¸', 'åº•æ¨™åƒ¹', 'æˆªæ¨™æ—¥', 'æˆªæ¨™æ”¶ç›¤', 'è½‰æ›åƒ¹',
                    'è¨‚åƒ¹æº¢åƒ¹ç‡', 'ç†è«–åƒ¹', 'æœ€ä½å¾—æ¨™', 'æœ€ä½æº¢åƒ¹',
                    'å¹³å‡å¾—æ¨™', 'å¹³å‡æº¢åƒ¹', 'æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€ä½',
                    'ç™¼è¡Œåˆ¸å•†', 'ç”¢æ¥­åˆ†é¡', 'åˆæ ¼ä»¶æ•¸', 'æŠ•æ¨™å¼µæ•¸',
                    'æŠ•æ¨™å€æ•¸', 'æŠ•æ¨™å‡å¼µ', 'CBæœ€æ–°æ”¶ç›¤åƒ¹'
                ];
                
                const firstRow = jsonData[0];
                const actualColumns = Object.keys(firstRow);
                
                log(`å¯¦éš›æ¬„ä½æ•¸: ${actualColumns.length}`, 'info');
                log(`æ¬„ä½åˆ—è¡¨: ${actualColumns.join(', ')}`, 'info');
                
                // æª¢æŸ¥ç¼ºå°‘çš„æ¬„ä½
                const missingColumns = requiredColumns.filter(col => !actualColumns.includes(col));
                if (missingColumns.length > 0) {
                    log(`âš ï¸ ç¼ºå°‘æ¬„ä½: ${missingColumns.join(', ')}`, 'error');
                } else {
                    log('âœ… æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å­˜åœ¨', 'success');
                }
                
                // é¡¯ç¤ºå‰3ç­†è³‡æ–™é è¦½
                log('6ï¸âƒ£ è³‡æ–™é è¦½ï¼ˆå‰3ç­†ï¼‰...', 'info');
                previewDiv.innerHTML = '<h3>ğŸ“‹ è³‡æ–™é è¦½ï¼ˆå‰3ç­†ï¼‰</h3>';
                
                const previewData = jsonData.slice(0, 3);
                let tableHTML = '<table><thead><tr>';
                
                // åªé¡¯ç¤ºä¸»è¦æ¬„ä½
                const displayColumns = ['åºè™Ÿ', 'é–‹æ¨™æ—¥æœŸ', 'è‚¡ç¥¨ä»£è™Ÿ', 'CBä»£è™Ÿ', 'åç¨±', 'ç”¢æ¥­åˆ†é¡', 'æŠ•æ¨™å€æ•¸'];
                displayColumns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewData.forEach(row => {
                    tableHTML += '<tr>';
                    displayColumns.forEach(col => {
                        tableHTML += `<td>${row[col] || '-'}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                previewDiv.innerHTML += tableHTML;
                
                showStatus(`âœ… è¼‰å…¥æˆåŠŸï¼å…± ${jsonData.length} ç­†è³‡æ–™`, 'success');
                log('========== æ¸¬è©¦æˆåŠŸ ==========', 'success');
                
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
                log(`éŒ¯èª¤å †ç–Š: ${error.stack}`, 'error');
                
                let errorMessage = '';
                let suggestion = '';
                
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    errorMessage = 'âŒ æ‰¾ä¸åˆ° auction_data.xlsx æª”æ¡ˆ';
                    suggestion = `
                        <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                        â€¢ æª”æ¡ˆä¸å­˜åœ¨<br>
                        â€¢ æª”æ¡ˆåç¨±ä¸æ­£ç¢ºï¼ˆæ³¨æ„å¤§å°å¯«ï¼‰<br>
                        â€¢ æª”æ¡ˆä¸åœ¨åŒä¸€å€‹ç›®éŒ„<br><br>
                        <strong>è§£æ±ºæ–¹å¼ï¼š</strong><br>
                        1. ç¢ºèªæª”æ¡ˆåç¨±å®Œå…¨æ˜¯ "auction_data.xlsx"<br>
                        2. ç¢ºèªæ­¤HTMLæª”èˆ‡Excelæª”åœ¨åŒä¸€å€‹è³‡æ–™å¤¾<br>
                        3. é‡æ–°æ•´ç†é é¢
                    `;
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'âŒ CORSè·¨åŸŸå•é¡Œ';
                    suggestion = `
                        <strong>è§£æ±ºæ–¹å¼ï¼š</strong><br>
                        1. ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨ï¼ˆæ¨è–¦ï¼‰<br>
                        2. æˆ–ä¸Šå‚³åˆ°ç¶²ç«™ç©ºé–“<br>
                        3. æˆ–ä½¿ç”¨ VS Code çš„ Live Server å¤–æ›
                    `;
                } else {
                    errorMessage = 'âŒ æœªçŸ¥éŒ¯èª¤';
                    suggestion = `
                        <strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong>${error.message}<br><br>
                        <strong>å»ºè­°ï¼š</strong><br>
                        1. æª¢æŸ¥Excelæª”æ¡ˆæ˜¯å¦æ­£å¸¸<br>
                        2. å˜—è©¦é‡æ–°ä¸‹è¼‰æª”æ¡ˆ<br>
                        3. ä½¿ç”¨Chromeæˆ–Edgeç€è¦½å™¨<br>
                        4. æ¸…é™¤ç€è¦½å™¨å¿«å–
                    `;
                }
                
                showStatus(`${errorMessage}<br><br>${suggestion}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¨ºæ–·
        window.addEventListener('load', () => {
            log('è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’', 'success');
            log('é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€æŒ‰éˆ•é–‹å§‹æª¢æŸ¥ç³»çµ±', 'info');
        });
    </script>
</body>
</html>
